<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Model</title>
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --expense: #e07070;
            --border: #2a2a3a;
        }

        [data-theme="light"] {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f0f0f2;
            --text-primary: #1a1a1a;
            --text-secondary: #505060;
            --text-muted: #808090;
            --border: #e0e0e5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        /* =====================================================
           LAYOUT
           ===================================================== */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 14px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: background 0.3s, border-color 0.3s;
        }

        .logo-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { font-size: 22px; font-weight: 700; color: var(--accent); }
        .logo-subtitle { font-size: 11px; color: var(--text-muted); margin-bottom: 20px; }

        /* Theme toggle */
        .theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Main */
        .main {
            flex: 1;
            margin-left: 260px;
            padding: 24px 32px;
            overflow-x: hidden;
            min-width: 0;
        }

        /* =====================================================
           SIDEBAR NAVIGATION
           ===================================================== */
        .nav-section { margin-bottom: 16px; }

        .nav-section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            padding-left: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-add-btn {
            background: var(--bg-hover);
            border: none;
            color: var(--text-secondary);
            width: 18px;
            height: 18px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .nav-add-btn:hover { background: var(--accent); color: white; }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent); color: white; }

        .nav-item-target {
            margin-left: auto;
            font-size: 11px;
            opacity: 0.7;
            font-variant-numeric: tabular-nums;
        }

        .channel-reorder {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-right: 6px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .nav-item:hover .channel-reorder { opacity: 1; }

        .reorder-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            font-size: 8px;
            line-height: 1;
            width: 14px;
            height: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
        }

        .reorder-btn:hover:not(:disabled) { background: var(--bg-hover); color: var(--accent); }
        .reorder-btn:disabled { opacity: 0.2; cursor: not-allowed; }

        .channel-name { flex: 1; cursor: pointer; }

        .confidence-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .confidence-high { background: var(--success); }
        .confidence-medium { background: var(--warning); }
        .confidence-low { background: var(--danger); }

        /* Summary box in sidebar */
        .sidebar-summary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            transition: background 0.3s, border-color 0.3s;
        }

        .sidebar-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            padding: 3px 0;
            gap: 8px;
        }

        .sidebar-summary-row span:first-child { color: var(--text-muted); flex-shrink: 0; }
        .sidebar-summary-row span:last-child { font-weight: 600; }

        .sidebar-summary-row.highlight span:last-child { color: var(--success); }

        /* Help button */
        .help-btn {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .help-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* =====================================================
           PAGES
           ===================================================== */
        .page { display: none; overflow-x: hidden; max-width: 100%; }
        .page.active { display: block; }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
            position: relative;
            z-index: 10;
        }

        .page-title { font-size: 20px; font-weight: 700; }
        .page-subtitle { color: var(--text-muted); font-size: 12px; margin-top: 2px; }

        /* =====================================================
           BUTTONS
           ===================================================== */
        .btn {
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .btn:hover { background: var(--bg-hover); border-color: var(--accent); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { background: transparent; color: var(--danger); border-color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        .btn-group { display: flex; gap: 8px; }

        /* =====================================================
           CARDS
           ===================================================== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            transition: background 0.3s, border-color 0.3s;
            max-width: 100%;
            overflow-x: auto;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title { font-size: 13px; font-weight: 600; }

        /* =====================================================
           STATS GRID
           ===================================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
            max-width: 100%;
            position: relative;
            z-index: 10;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            transition: background 0.3s, border-color 0.3s;
        }

        .stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: 700; margin-top: 2px; }
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }

        /* =====================================================
           MATRIX TABLE
           ===================================================== */
        .matrix-container {
            overflow-x: auto;
            overflow-y: hidden;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: background 0.3s, border-color 0.3s;
            max-width: 100%;
            position: relative;
            z-index: 1;
            isolation: isolate;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .matrix-table th,
        .matrix-table td {
            padding: 8px 10px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .matrix-table th {
            background: var(--bg-secondary);
            font-size: 9px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .matrix-table th:first-child,
        .matrix-table td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--bg-card);
            min-width: 160px;
            z-index: 2;
        }

        .matrix-table th:first-child { background: var(--bg-secondary); z-index: 3; }

        .matrix-table tbody tr { cursor: pointer; }
        .matrix-table tbody tr:hover td { background: var(--bg-hover); }
        .matrix-table tbody tr:hover td:first-child { background: var(--bg-hover); }

        .matrix-table .totals-row {
            background: var(--bg-secondary);
            font-weight: 700;
            cursor: default;
        }

        .matrix-table .totals-row td {
            border-top: 2px solid var(--border);
            padding: 10px;
        }

        .matrix-table .totals-row td:first-child { background: var(--bg-secondary); }

        /* Week Matrix (Reforge Style) */
        .week-matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .week-matrix-table th,
        .week-matrix-table td {
            padding: 6px 8px;
            text-align: right;
            border: 1px solid var(--border);
            white-space: nowrap;
        }

        .week-matrix-table th {
            background: var(--bg-secondary);
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .week-matrix-table th:first-child,
        .week-matrix-table td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--bg-card);
            min-width: 180px;
            z-index: 5;
        }

        .week-matrix-table th:first-child {
            background: var(--bg-secondary);
            z-index: 15;
        }

        .week-matrix-table .channel-header-row {
            background: var(--bg-hover);
            font-weight: 700;
        }

        .week-matrix-table .channel-header-row td {
            background: var(--bg-hover);
            color: var(--text-primary);
            font-size: 12px;
            padding: 10px 8px;
        }

        .week-matrix-table .metric-row td {
            background: var(--bg-card);
        }

        .week-matrix-table .metric-row:hover td {
            background: var(--bg-hover);
        }

        .week-matrix-table .rate-cell {
            color: var(--text-muted);
            font-size: 10px;
        }

        .week-matrix-table .value-cell {
            color: var(--text-primary);
            font-weight: 500;
        }

        .week-matrix-table .activated-row td {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
            font-weight: 600;
        }

        .week-matrix-table .total-row {
            background: var(--bg-secondary);
            font-weight: 700;
        }

        .week-matrix-table .total-row td {
            background: var(--bg-secondary);
            border-top: 2px solid var(--accent);
            padding: 10px 8px;
        }

        /* Editable cells in matrix */
        .matrix-editable {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            padding: 3px 5px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            text-align: right;
            width: 70px;
            transition: all 0.1s;
        }

        .matrix-editable:hover {
            border-color: var(--border);
            background: var(--bg-secondary);
        }

        .matrix-editable:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .matrix-editable.rate { color: var(--warning); width: 55px; }

        .sidebar-editable {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            padding: 2px 4px;
            color: var(--text-primary);
            font-size: 11px;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.1s;
        }

        .sidebar-editable:hover {
            border-color: var(--border);
            background: var(--bg-hover);
        }

        .sidebar-editable:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        .calculated { color: var(--text-secondary); font-variant-numeric: tabular-nums; }
        .calculated.final { color: var(--success); font-weight: 700; }

        /* Channel name in matrix */
        .channel-cell {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .channel-cell-name { font-weight: 500; }

        /* =====================================================
           CHANNEL DETAIL PAGE
           ===================================================== */
        .detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .detail-back {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 12px;
            transition: all 0.2s;
        }

        .detail-back:hover { border-color: var(--accent); color: var(--accent); }

        /* Funnel visualization */
        .funnel { margin: 12px 0; }

        .funnel-step {
            display: grid;
            grid-template-columns: 140px 1fr 70px 50px 30px;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .funnel-step:last-child { border-bottom: none; }

        .funnel-step-label { font-size: 11px; color: var(--text-secondary); }

        .funnel-bar-container { position: relative; }

        .funnel-bar {
            height: 24px;
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            border-radius: 3px;
            transition: width 0.2s;
        }

        .funnel-step-value { font-weight: 600; text-align: right; font-size: 12px; }
        .funnel-step-rate { font-size: 11px; color: var(--warning); text-align: right; }

        .funnel-editable {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            padding: 2px 4px;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
            width: 100%;
        }

        .funnel-editable:hover { border-color: var(--border); background: var(--bg-secondary); }
        .funnel-editable:focus { outline: none; border-color: var(--accent); background: var(--bg-secondary); }

        /* =====================================================
           NOTES
           ===================================================== */
        .notes-list { margin-bottom: 12px; }

        .note-item {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 6px;
            transition: background 0.3s;
        }

        .note-item-header {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .note-item-content { font-size: 12px; }

        .note-input-row { display: flex; gap: 8px; }

        .note-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            color: var(--text-primary);
            font-size: 12px;
            transition: background 0.3s, border-color 0.3s;
        }

        .note-input:focus { outline: none; border-color: var(--accent); }

        /* =====================================================
           WEEKLY VIEW
           ===================================================== */
        .weekly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .weekly-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            transition: background 0.3s, border-color 0.3s;
        }

        .weekly-card.current { border-color: var(--accent); }

        .weekly-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .weekly-card-title { font-weight: 600; font-size: 12px; }
        .weekly-card-dates { font-size: 10px; color: var(--text-muted); }

        .weekly-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .weekly-metric { text-align: center; }
        .weekly-metric-value { font-size: 16px; font-weight: 700; }
        .weekly-metric-label { font-size: 9px; color: var(--text-muted); }

        .weekly-editable {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            padding: 2px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 700;
            font-family: inherit;
            text-align: center;
            width: 60px;
        }

        .weekly-editable:hover { border-color: var(--border); }
        .weekly-editable:focus { outline: none; border-color: var(--accent); background: var(--bg-secondary); }

        /* =====================================================
           SCENARIO TOGGLE
           ===================================================== */
        .scenario-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 3px;
            transition: background 0.3s;
        }

        .scenario-option {
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.15s;
        }

        .scenario-option.active { background: var(--accent); color: white; }
        .scenario-option:hover:not(.active) { color: var(--text-primary); }

        /* =====================================================
           MODALS
           ===================================================== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transition: background 0.3s, border-color 0.3s;
        }

        .modal-title { font-size: 16px; font-weight: 700; margin-bottom: 14px; }

        .form-group { margin-bottom: 12px; }
        .form-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; display: block; }

        .form-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            color: var(--text-primary);
            font-size: 13px;
            transition: background 0.3s, border-color 0.3s;
        }

        .form-input:focus { outline: none; border-color: var(--accent); }

        .confidence-selector { display: flex; gap: 6px; }

        .confidence-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            opacity: 0.4;
            transition: all 0.15s;
        }

        .confidence-option:hover { opacity: 0.7; }
        .confidence-option.selected { opacity: 1; border-color: var(--text-primary); }
        .confidence-option.high { background: var(--success); }
        .confidence-option.medium { background: var(--warning); }
        .confidence-option.low { background: var(--danger); }

        /* =====================================================
           ONBOARDING MODAL
           ===================================================== */
        .onboarding-step { margin-bottom: 20px; }

        .onboarding-step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            margin-right: 10px;
        }

        .onboarding-step-title {
            display: inline;
            font-size: 14px;
            font-weight: 600;
        }

        .onboarding-step-desc {
            margin-top: 8px;
            margin-left: 34px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .onboarding-tip {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent);
            padding: 10px 12px;
            margin: 16px 0;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .onboarding-tip strong { color: var(--text-primary); }

        .onboarding-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .onboarding-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .onboarding-checkbox input { width: 14px; height: 14px; }

        /* =====================================================
           TOAST
           ===================================================== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--success);
            padding: 12px 18px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.show { display: flex; }
        .toast.toast-success { border-color: var(--success); color: var(--success); }
        .toast.toast-warning { border-color: #f59e0b; color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .toast.toast-error { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* =====================================================
           MISC
           ===================================================== */
        .delete-btn {
            opacity: 0;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 14px;
            padding: 0 4px;
            transition: opacity 0.15s;
        }

        tr:hover .delete-btn,
        .funnel-step:hover .delete-btn { opacity: 0.6; }
        .delete-btn:hover { opacity: 1 !important; }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-draft { background: rgba(99, 102, 241, 0.2); color: var(--accent); }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* =====================================================
           FINANCIAL MODEL STYLES
           ===================================================== */
        .financial-settings-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
            max-width: 100%;
            position: relative;
            z-index: 1;
        }

        .financial-setting-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            flex: 0 0 auto;
            min-width: 160px;
            max-width: 200px;
            position: relative;
            overflow: visible;
        }

        /* Wider cards for campaign detail page */
        #page-campaign .financial-settings-grid {
            gap: 20px;
        }

        #page-campaign .financial-setting-card {
            min-width: 240px;
            max-width: 320px;
            padding: 18px;
        }

        #page-campaign .financial-input-row {
            padding: 8px 0;
            gap: 12px;
        }

        #page-campaign .financial-input {
            width: auto;
            min-width: 120px;
        }

        #page-campaign .financial-input[type="text"] {
            text-align: left;
        }

        #page-campaign select.financial-input {
            text-align: left;
        }

        /* Stream detail page */
        #page-stream .financial-settings-grid {
            gap: 20px;
        }
        #page-stream .financial-setting-card {
            min-width: 240px;
            max-width: 320px;
            padding: 18px;
        }
        #page-stream .financial-input-row {
            padding: 8px 0;
            gap: 12px;
        }
        #page-stream .financial-input {
            width: auto;
            min-width: 120px;
        }

        #page-expense .financial-settings-grid {
            gap: 20px;
        }

        #page-expense .financial-setting-card {
            min-width: 240px;
            max-width: 320px;
            padding: 18px;
        }

        #page-expense .financial-input-row {
            padding: 8px 0;
            gap: 12px;
        }

        #page-expense .financial-input {
            width: auto;
            min-width: 120px;
        }

        #page-expense .financial-input[type="text"] {
            text-align: left;
        }

        .financial-setting-card h4 {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .financial-input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
            gap: 8px;
        }

        .financial-input-row:last-child {
            border-bottom: none;
        }

        .financial-input-row label {
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .financial-input {
            width: 60px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 3px 6px;
            color: var(--text-primary);
            font-size: 11px;
            text-align: right;
        }

        .financial-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .financial-input.currency::before {
            content: '$';
        }

        /* Tooltip styles */
        .tooltip-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg-hover);
            color: var(--text-muted);
            font-size: 9px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            margin-left: 4px;
            flex-shrink: 0;
        }

        .tooltip-icon:hover {
            background: var(--accent);
            color: white;
        }

        .tooltip-content {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 10px;
            color: var(--text-secondary);
            width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 99999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
            pointer-events: none;
        }

        .tooltip-wrapper:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-content strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 4px;
        }

        .revenue-chart {
            min-height: 220px;
            display: flex;
            align-items: flex-end;
            gap: 6px;
            padding: 24px 8px 16px 8px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            overflow-y: visible;
        }

        .revenue-bar {
            flex: 1;
            min-width: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .revenue-bar-stack {
            width: 100%;
            display: flex;
            flex-direction: column-reverse;
            border-radius: 4px 4px 0 0;
            overflow: hidden;
        }

        .revenue-bar-segment {
            transition: height 0.3s;
        }

        .revenue-bar-label {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .revenue-bar-value {
            font-size: 10px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .metric-card-large {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            text-align: center;
        }

        .metric-card-large .metric-value {
            font-size: 24px;
            font-weight: 700;
            margin: 6px 0;
        }

        .metric-card-large .metric-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .metric-card-large .metric-change {
            font-size: 10px;
            margin-top: 4px;
        }

        .metric-card-large .metric-change.positive {
            color: var(--success);
        }

        .metric-card-large .metric-change.negative {
            color: var(--danger);
        }

        .financial-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .financial-table th,
        .financial-table td {
            padding: 6px 8px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .financial-table th {
            background: var(--bg-secondary);
            font-size: 9px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .financial-table th:first-child,
        .financial-table td:first-child {
            text-align: left;
        }

        .financial-table .highlight-row {
            background: rgba(99, 102, 241, 0.1);
        }

        .financial-table .total-row {
            background: var(--bg-secondary);
            font-weight: 700;
        }

        .revenue-legend {
            display: flex;
            gap: 16px;
            justify-content: center;
            padding: 8px 0;
            font-size: 10px;
        }

        .revenue-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .revenue-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .campaign-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .campaign-row:hover {
            background: var(--bg-hover);
        }

        .campaign-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .campaign-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .campaign-status.planned {
            background: var(--warning);
        }

        .campaign-status.active {
            background: var(--success);
        }

        .campaign-status.completed {
            background: var(--text-muted);
        }

        .scenario-toggle-financial {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 2px;
            margin-bottom: 12px;
        }

        .scenario-option-financial {
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.15s;
            flex: 1;
            text-align: center;
        }

        .scenario-option-financial.active {
            background: var(--accent);
            color: white;
        }

        .scenario-option-financial:hover:not(.active) {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-row">
                <div class="logo">üìà Growth</div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <span id="theme-icon">‚òÄÔ∏è</span>
                </button>
            </div>
            <div class="logo-subtitle">Growth Model v2.0</div>

            <!-- Summary -->
            <div class="sidebar-summary" id="sidebar-summary"></div>

            <nav id="sidebar-nav"></nav>

            <!-- Help buttons -->
            <button class="help-btn" onclick="showOnboarding()">üöÄ Quick Start Guide</button>
            <button class="help-btn" onclick="showPage('docs')" style="margin-top: 6px;">üìñ Full Documentation</button>

            <!-- Auto-save status -->
            <div style="margin-top: 16px; padding: 10px; background: var(--bg-card); border-radius: 6px; border: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 6px; font-size: 11px;">
                    <span id="save-status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--success);"></span>
                    <span id="save-status-text">Auto-save enabled</span>
                    <span id="unsaved-indicator" style="display: none; color: var(--warning);">*</span>
                </div>
                <p style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                    Changes save to growth-model-data.json
                </p>
            </div>

            <!-- Data actions -->
            <div class="nav-section" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                <div class="nav-item" onclick="autoSave()">Force Save Now</div>
                <div class="nav-item" onclick="exportJSON()">Export JSON</div>
                <div class="nav-item" onclick="importJSON()">Import JSON</div>
                <div class="nav-item" onclick="resetToDefaults()" style="color: var(--danger);">Reset to Defaults</div>
            </div>

            <!-- Attribution (configurable via data.project.branding) -->
            <div id="sidebar-branding" style="margin-top: auto; padding-top: 16px; text-align: center;"></div>
        </aside>

        <!-- Main Content -->
        <main class="main">

            <!-- ==================== MATRIX PAGE ==================== -->
            <div class="page active" id="page-matrix">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Growth Model Overview</h1>
                        <p class="page-subtitle">Click any channel row to see full details</p>
                    </div>
                    <div class="btn-group">
                        <div class="scenario-toggle" id="scenario-toggle">
                            <div class="scenario-option active" data-mult="1">Base</div>
                            <div class="scenario-option" data-mult="0.7">Conservative</div>
                            <div class="scenario-option" data-mult="1.3">Optimistic</div>
                        </div>
                        <button class="btn" onclick="openAddChannelModal()">+ Add Channel</button>
                    </div>
                </div>

                <div class="stats-grid" id="matrix-stats"></div>

                <div class="matrix-container">
                    <table class="matrix-table" id="matrix-table">
                        <thead id="matrix-head"></thead>
                        <tbody id="matrix-body"></tbody>
                    </table>
                </div>

                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">Model Notes & Learnings</span>
                    </div>
                    <div class="notes-list" id="global-notes"></div>
                    <div class="note-input-row">
                        <input type="text" class="note-input" id="global-note-input" placeholder="Add a note about assumptions, learnings, or changes...">
                        <button class="btn btn-primary btn-sm" onclick="addGlobalNote()">Add</button>
                    </div>
                </div>
            </div>

            <!-- ==================== CHANNEL DETAIL PAGE ==================== -->
            <div class="page" id="page-channel">
                <div class="detail-header">
                    <button class="detail-back" onclick="showPage('matrix')">‚Üê Back to Matrix</button>
                    <div>
                        <h1 class="page-title" id="channel-title">Channel Name</h1>
                        <p class="page-subtitle" id="channel-subtitle">Description</p>
                    </div>
                </div>
                <div id="channel-content"></div>
            </div>

            <!-- ==================== TIME PROJECTION PAGE ==================== -->
            <div class="page" id="page-projection">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Time Projection Model</h1>
                        <p class="page-subtitle">Click any channel row to edit its weekly breakdown</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="takeSnapshot()" style="background: var(--success); color: #fff;">Take Snapshot</button>
                        <button class="btn" onclick="addProjectionWeek()">+ Add Week</button>
                        <button class="btn" onclick="removeProjectionWeek()">- Remove Last</button>
                    </div>
                </div>

                <!-- Growth Settings -->
                <div class="stats-grid" style="margin-bottom: 16px;">
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Starting Users
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Starting Users</strong>
                                    Base user count at week 0. This is your current active user base before growth channels kick in.
                                </div>
                            </div>
                        </div>
                        <input type="number" class="weekly-editable" id="proj-start-users" value="1500" style="font-size: 20px;" onchange="updateProjectionSettings()">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Weekly Organic (%)
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Organic Growth Rate</strong>
                                    Percentage of existing users that bring new organic users each week through word-of-mouth and natural discovery.
                                </div>
                            </div>
                        </div>
                        <input type="number" class="weekly-editable" id="proj-organic-rate" value="1.25" step="0.25" style="font-size: 20px; color: var(--success);" onchange="updateProjectionSettings()">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Weekly Churn (%)
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Churn Rate</strong>
                                    Percentage of users lost each week. Higher churn means users leave faster.
                                </div>
                            </div>
                        </div>
                        <input type="number" class="weekly-editable" id="proj-churn-rate" value="0.75" step="0.25" style="font-size: 20px; color: var(--danger);" onchange="updateProjectionSettings()">
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                K-Factor (Viral)
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>K-Factor</strong>
                                    Viral coefficient. Number of new users each existing user brings in through referrals. 0.1 = each user brings 0.1 new users.
                                </div>
                            </div>
                        </div>
                        <input type="number" class="weekly-editable" id="proj-k-factor" value="0.04" step="0.01" style="font-size: 20px; color: var(--accent);" onchange="updateProjectionSettings()">
                    </div>
                </div>

                <!-- Channel Projection Matrix -->
                <div class="matrix-container">
                    <table class="matrix-table" id="projection-table">
                        <thead id="projection-head"></thead>
                        <tbody id="projection-body"></tbody>
                    </table>
                </div>

                <!-- Projection Chart -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">Growth Trajectory</span>
                    </div>
                    <div id="projection-chart" style="height: 200px; display: flex; align-items: flex-end; gap: 4px; padding: 20px 0;"></div>
                </div>
            </div>

            <!-- ==================== CHANNEL PROJECTION DETAIL PAGE ==================== -->
            <div class="page" id="page-channel-projection">
                <div class="detail-header">
                    <button class="detail-back" onclick="showPage('projection')">‚Üê Back to Projection</button>
                    <div>
                        <h1 class="page-title" id="channel-proj-title">Channel Name</h1>
                        <p class="page-subtitle" id="channel-proj-subtitle">Edit weekly multipliers for this channel</p>
                    </div>
                </div>
                <div id="channel-proj-content"></div>
            </div>

            <!-- ==================== ACTIVATIONS TIMELINE PAGE ==================== -->
            <div class="page" id="page-activations">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Activations Timeline</h1>
                        <p class="page-subtitle">Organize your channels into timeline phases</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="openAddPhaseModal()">+ Add Phase</button>
                    </div>
                </div>
                <div id="activations-content"></div>
            </div>

            <!-- ==================== WEEK MATRIX PAGE (REFORGE STYLE) ==================== -->
            <div class="page" id="page-weekmatrix">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Acquisition Details</h1>
                        <p class="page-subtitle">Reforge-style week-by-week breakdown of all acquisition channels</p>
                    </div>
                </div>
                <div class="week-matrix-container" style="overflow-x: auto;">
                    <table class="week-matrix-table" id="week-matrix-table">
                        <thead id="week-matrix-head"></thead>
                        <tbody id="week-matrix-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ==================== DOCUMENTATION PAGE ==================== -->
            <div class="page" id="page-docs">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Documentation</h1>
                        <p class="page-subtitle">Complete guide to the Growth Model</p>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">What is this tool?</h3>
                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.7;">
                        The Growth Model is a <strong>funnel-based acquisition and financial planning tool</strong> that helps you:
                    </p>
                    <ul style="font-size: 13px; color: var(--text-secondary); line-height: 1.8; margin: 12px 0 0 20px;">
                        <li>Model user acquisition across multiple channels with per-step conversion rates</li>
                        <li>Project growth over time with compounding, churn, and viral effects</li>
                        <li>Plan revenue streams (subscriptions, campaigns, fixed contracts, and more)</li>
                        <li>Track expenses and model profitability week by week</li>
                        <li>Save snapshots and compare planned vs actual performance</li>
                        <li>Export/import your entire model as JSON for sharing and backup</li>
                    </ul>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Views Explained</h3>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 8px;">1. Matrix Overview</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                            The condensed view showing all channels as rows and funnel steps as columns.
                            <strong>Edit any value directly</strong> in the table. Changes cascade automatically to downstream calculations.
                            The final "Activations" column shows how many users each channel delivers per period.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 8px;">2. Channel Detail</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                            Click any channel row to see the full funnel visualization with bars.
                            Here you can rename steps, add/remove funnel stages, adjust confidence levels, and keep notes.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 8px;">3. Time Projection</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                            Project your model forward week by week. Configure organic growth rates, churn, and viral K-factor
                            to see how your user base compounds over time. Add or remove weeks to adjust the timeline.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 8px;">4. Financial Projections</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                            The financial model synced with the Time Projection timeline. Shows weekly revenue (subscriptions, campaigns, custom streams),
                            expenses, and net profit. Click any revenue stream or expense row to open its detail page for editing.
                            Add custom revenue streams and expenses with the buttons in the header.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 8px;">5. Planned vs Actual</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                            Compare your model's projections against reality. Save snapshots of your current model at key milestones,
                            enter actual weekly numbers, and see a comparison chart overlaying planned vs actual data.
                        </p>
                    </div>

                    <div>
                        <h4 style="font-size: 14px; color: var(--accent); margin-bottom: 8px;">6. Documentation</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.7;">
                            This page. A reference guide for all features in the tool.
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Revenue Streams</h3>

                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            All revenue is modeled through custom streams. Each stream has a name, launch week, and one of three types:
                        </p>
                        <ul style="font-size: 12px; color: var(--text-secondary); line-height: 1.8; margin: 8px 0 0 20px;">
                            <li><strong>Fixed Monthly:</strong> A flat monthly amount divided by 4 per week. Good for consulting, retainers, or fixed contracts.</li>
                            <li><strong>User-Based:</strong> Accumulates premium users based on a conversion rate and churn rate, with revenue = premium users x weekly price. Good for subscription models.</li>
                            <li><strong>Campaign-Based:</strong> Revenue = active users x cost per user x monthly activations. Define activations per month index. Good for sponsored notification or advertising models.</li>
                        </ul>
                    </div>

                    <div>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            Click any stream name in the Financial table to open its detail page, where you can edit all fields, view monthly revenue breakdown, and delete the stream.
                            Use the "+ Revenue" button to add new streams.
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Expenses</h3>
                    <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px;">
                        Track monthly expenses that reduce your net profit. Each expense has a name, monthly amount, and launch week.
                    </p>
                    <ul style="font-size: 12px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
                        <li><strong>Monthly ratio:</strong> Adjust per-month cost scaling (e.g., half cost in month 1, full cost from month 2 onward). Edit ratios on the expense detail page.</li>
                        <li><strong>Launch week:</strong> The week when the expense starts being counted.</li>
                        <li><strong>Detail page:</strong> Click an expense name in the Financial table to edit its fields and view monthly cost breakdown.</li>
                    </ul>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Key Concepts</h3>

                    <div style="margin-bottom: 16px;">
                        <h4 style="font-size: 13px; color: var(--warning); margin-bottom: 6px;">Conversion Rates (%)</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            The percentage of users that move from one funnel step to the next. Displayed in yellow.
                            These are your key levers: small improvements compound through the funnel.
                        </p>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <h4 style="font-size: 13px; margin-bottom: 6px;">Confidence Indicators</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            <span style="color: var(--danger);">Low</span> = Pure assumption, not validated<br>
                            <span style="color: var(--warning);">Medium</span> = Some data or experience backs it<br>
                            <span style="color: var(--success);">High</span> = Validated with real data
                        </p>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <h4 style="font-size: 13px; margin-bottom: 6px;">Scenarios</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>Base</strong> = Your expected case (1.0x rates)<br>
                            <strong>Conservative</strong> = Pessimistic (0.7x rates)<br>
                            <strong>Optimistic</strong> = Best case (1.3x rates)
                        </p>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <h4 style="font-size: 13px; margin-bottom: 6px;">K-Factor (Viral Coefficient)</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            How many new users each existing user brings via referrals.
                            K=0.15 means 100 users bring 15 new users. K>1 means exponential viral growth.
                        </p>
                    </div>

                    <div>
                        <h4 style="font-size: 13px; margin-bottom: 6px;">Phases &amp; Platforms</h4>
                        <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            Tag channels with phases (e.g., "Launch", "Scale") and platforms (e.g., "Telegram", "Twitter")
                            to organize your acquisition model. Manage them from the Matrix Overview sidebar.
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Snapshots &amp; Actuals</h3>
                    <ul style="font-size: 12px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
                        <li><strong>Save snapshot:</strong> Capture the current state of your growth projections at a milestone (e.g., "Pre-launch plan", "Post-pivot v2").</li>
                        <li><strong>Compare:</strong> The comparison chart overlays your latest snapshot against actual numbers so you can track divergence.</li>
                        <li><strong>Actual numbers:</strong> Enter real weekly user counts as they come in. These are used in the comparison chart and for validating your model.</li>
                    </ul>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Data Management</h3>
                    <ul style="font-size: 12px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
                        <li><strong>Auto-save:</strong> All changes save automatically to your browser (localStorage).</li>
                        <li><strong>Export JSON:</strong> Download your entire model as a JSON file for backup or sharing.</li>
                        <li><strong>Import JSON:</strong> Load a previously exported model. Replaces all current data.</li>
                        <li><strong>Server sync:</strong> If deployed to Netlify/Vercel, data syncs to a serverless backend automatically.</li>
                        <li><strong>Theme:</strong> Toggle dark/light mode with the button in the header.</li>
                    </ul>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; margin-bottom: 12px;">Tips</h3>
                    <ol style="font-size: 12px; color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
                        <li><strong>Start with assumptions</strong> and mark everything as low confidence initially.</li>
                        <li><strong>Validate and update</strong> as you get real data. Increase confidence levels accordingly.</li>
                        <li><strong>Use notes liberally</strong> on channel detail pages to document why you changed numbers.</li>
                        <li><strong>Save snapshots</strong> before making major changes so you can compare later.</li>
                        <li><strong>Export regularly</strong> to keep backups of your model at key milestones.</li>
                        <li><strong>Click row names</strong> in the Financial table to open detail pages for streams and expenses.</li>
                    </ol>
                </div>
            </div>

            <!-- ==================== FINANCIAL PAGE ==================== -->
            <div class="page" id="page-financial">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Financial Projections</h1>
                        <p class="page-subtitle">Click a revenue stream row to see details. Timeline synced with Time Projection.</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="addProjectionWeek(); renderFinancial();">+ Add Week</button>
                        <button class="btn" onclick="removeProjectionWeek(); renderFinancial();">- Remove Last</button>
                        <button class="btn" onclick="addCustomRevenueStream();" style="background: var(--success);">+ Revenue</button>
                        <button class="btn" onclick="addExpense();" style="background: var(--expense);">+ Expense</button>
                        <div class="scenario-toggle" id="financial-scenario-toggle">
                            <div class="scenario-option active" data-scenario="base" onclick="setFinancialScenario('base')">Base</div>
                            <div class="scenario-option" data-scenario="conservative" onclick="setFinancialScenario('conservative')">Conservative</div>
                            <div class="scenario-option" data-scenario="optimistic" onclick="setFinancialScenario('optimistic')">Optimistic</div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="stats-grid" id="financial-metrics">
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Monthly Revenue
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Monthly Revenue</strong>
                                    Estimated monthly revenue based on the last week's performance x 4. Includes all revenue streams.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value success" id="fin-mrr">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Monthly OPEX
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Monthly OPEX</strong>
                                    Operating Expenses. Total monthly costs including salaries, servers, subscriptions, legal, and other operational costs.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="fin-opex" style="color: var(--expense);">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Monthly EBITDA
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Monthly EBITDA</strong>
                                    Earnings Before Interest, Taxes, Depreciation & Amortization. Calculated as Revenue minus OPEX. A key profitability metric.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="fin-ebitda">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                EBITDA Margin
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>EBITDA Margin</strong>
                                    EBITDA as a percentage of Revenue. Shows operational efficiency. Higher is better. Formula: (EBITDA / Revenue) √ó 100.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="fin-ebitda-margin">0%</div>
                    </div>
                </div>

                <!-- Financial Matrix Table (weeks as columns, like Time Projection) -->
                <div class="matrix-container">
                    <table class="matrix-table" id="financial-matrix-table">
                        <thead id="financial-matrix-head"></thead>
                        <tbody id="financial-matrix-body"></tbody>
                    </table>
                </div>

                <!-- Revenue Chart (below table) -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">Revenue Projection</span>
                        <span id="fin-weeks-count" style="font-size: 11px; color: var(--text-muted);"></span>
                    </div>
                    <div class="revenue-legend" id="revenue-legend">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="revenue-chart" id="revenue-chart"></div>
                </div>
            </div>

                                    <!-- ==================== CAMPAIGN DETAIL PAGE ==================== -->
            <div class="page" id="page-campaign">
                <div class="detail-header">
                    <button class="detail-back" onclick="showPage('financial')">‚Üê Back to Financial</button>
                    <div>
                        <h1 class="page-title" id="campaign-title" style="color: var(--success);">Campaign Name</h1>
                        <p class="page-subtitle" id="campaign-subtitle">Edit campaign details</p>
                    </div>
                    <div class="btn-group" style="margin-left: auto;">
                        <button class="btn" onclick="addProjectionWeek(); renderCampaignDetail(currentCampaignId);">+ Add Week</button>
                        <button class="btn" onclick="removeProjectionWeek(); renderCampaignDetail(currentCampaignId);">- Remove Last</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Projected Revenue
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Projected Revenue</strong>
                                    Total expected revenue from this campaign. Calculated as Average Active Users √ó Cost per User √ó Total Activations.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value success" id="campaign-revenue">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Active Months
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Active Months</strong>
                                    Number of months where this campaign has at least one activation scheduled.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="campaign-active-months">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Total Activations
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Total Activations</strong>
                                    Sum of all activation multipliers across all months. Each activation represents one sponsored notification push to users.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="campaign-total-activations">0</div>
                    </div>
                </div>

                <div class="financial-settings-grid" style="margin-bottom: 24px;">
                    <div class="financial-setting-card">
                        <h4>Campaign Details</h4>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Campaign Name</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Campaign Name</strong>
                                    A descriptive name for this campaign/client.
                                </div>
                            </div>
                            <input type="text" class="financial-input" id="campaign-name" style="width: 180px;" onchange="updateCampaignField('name', this.value)">
                        </div>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Client / Protocol</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Client / Protocol</strong>
                                    The business or protocol sponsoring this campaign.
                                </div>
                            </div>
                            <input type="text" class="financial-input" id="campaign-client" style="width: 180px;" onchange="updateCampaignField('client', this.value)">
                        </div>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Status</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Campaign Status</strong>
                                    Track the progress: Planned, Active, or Completed.
                                </div>
                            </div>
                            <select class="financial-input" id="campaign-status" style="width: 120px;" onchange="updateCampaignField('status', this.value)">
                                <option value="planned">Planned</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="deleteCampaignFromDetail()">
                                Delete Campaign
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Monthly Activation Plan -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <span class="card-title">Monthly Activation Plan</span>
                        <span style="font-size: 10px; color: var(--text-muted);">Set multiplier for each month (0 = inactive, 1 = one campaign, 2 = two campaigns, etc.)</span>
                    </div>
                    <div style="padding: 16px; overflow-x: auto;">
                        <div id="campaign-monthly-plan" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                    </div>
                    <div style="padding: 0 16px 16px; font-size: 11px; color: var(--text-muted);">
                        <strong>Revenue calculation:</strong> Active Users √ó $<span id="campaign-cost-per-user">0.40</span> √ó Multiplier = Monthly Revenue
                    </div>
                </div>

                <!-- Campaign Notes -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <span class="card-title">Notes</span>
                    </div>
                    <div style="padding: 16px;">
                        <textarea id="campaign-notes" style="width: 100%; min-height: 100px; resize: vertical; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: var(--text-primary); font-size: 12px; font-family: inherit;" placeholder="Add notes about this campaign..." onchange="updateCampaignField('notes', this.value)"></textarea>
                    </div>
                </div>
            </div>

            <!-- ==================== EXPENSE DETAIL PAGE ==================== -->
            <div class="page" id="page-expense">
                <div class="detail-header">
                    <button class="detail-back" onclick="showPage('financial')">‚Üê Back to Financial</button>
                    <div>
                        <h1 class="page-title" id="expense-title" style="color: var(--expense);">Expense Name</h1>
                        <p class="page-subtitle" id="expense-subtitle">Edit expense details</p>
                    </div>
                    <div class="btn-group" style="margin-left: auto;">
                        <button class="btn" onclick="addProjectionWeek(); renderExpenseDetail(currentExpenseId);">+ Add Week</button>
                        <button class="btn" onclick="removeProjectionWeek(); renderExpenseDetail(currentExpenseId);">- Remove Last</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Monthly Cost
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Monthly Cost</strong>
                                    The fixed monthly amount for this expense category. Divided by 4 to calculate weekly cost.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="expense-monthly" style="color: var(--expense);">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Total Cost (Period)
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Total Cost</strong>
                                    Cumulative cost across all active weeks in the projection period.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="expense-total" style="color: var(--expense);">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Active Weeks
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Active Weeks</strong>
                                    Number of weeks this expense is active, from the start week to the end of the projection period.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" id="expense-active-weeks">0</div>
                    </div>
                </div>

                <div class="financial-settings-grid" style="margin-bottom: 24px;">
                    <div class="financial-setting-card">
                        <h4>Expense Details</h4>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Expense Name</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Expense Name</strong>
                                    A descriptive name for this expense category.
                                </div>
                            </div>
                            <input type="text" class="financial-input" id="expense-name" style="width: 180px;" onchange="updateExpenseField('name', this.value)">
                        </div>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Monthly Amount</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Monthly Amount</strong>
                                    The monthly cost for this expense category.
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: var(--text-muted);">$</span>
                                <input type="number" class="financial-input" id="expense-amount" style="width: 100px;" onchange="updateExpenseField('monthlyAmount', this.value)">
                            </div>
                        </div>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Start Week</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Start Week</strong>
                                    Week number when this expense begins (0 = first week).
                                </div>
                            </div>
                            <input type="number" class="financial-input" id="expense-launch-week" style="width: 80px;" min="0" max="47" onchange="updateExpenseField('launchWeek', this.value)">
                        </div>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Monthly Ratio</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Monthly Ratio</strong>
                                    Growth multiplier applied every month (4 weeks). 1 = stable, 1.1 = +10%/month, 0.9 = -10%/month.
                                </div>
                            </div>
                            <input type="number" class="financial-input" id="expense-ratio" style="width: 80px;" step="0.01" min="0" onchange="updateExpenseField('monthlyRatio', this.value)">
                        </div>
                        <div class="financial-input-row">
                            <div class="tooltip-wrapper">
                                <label>Status</label>
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Status</strong>
                                    Enable or disable this expense in calculations.
                                </div>
                            </div>
                            <select class="financial-input" id="expense-enabled" style="width: 100px;" onchange="updateExpenseField('enabled', this.value === 'true')">
                                <option value="true">Active</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn btn-sm" style="background: var(--expense); color: white;" onclick="deleteExpenseFromDetail()">
                                Delete Expense
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Monthly Cost Timeline -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <span class="card-title">Monthly Cost Timeline</span>
                        <span style="font-size: 10px; color: var(--text-muted);">Cost distribution by month</span>
                    </div>
                    <div style="padding: 16px; overflow-x: auto;">
                        <div id="expense-weekly-timeline" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
                    </div>
                </div>

                <!-- Expense Notes -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <span class="card-title">Notes</span>
                    </div>
                    <div style="padding: 16px;">
                        <textarea id="expense-notes" style="width: 100%; min-height: 100px; resize: vertical; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: var(--text-primary); font-size: 12px; font-family: inherit;" placeholder="Add notes about this expense..." onchange="updateExpenseField('notes', this.value)"></textarea>
                    </div>
                </div>
            </div>

            <!-- ==================== STREAM DETAIL PAGE ==================== -->
            <div class="page" id="page-stream">
                <div class="detail-header">
                    <button class="detail-back" onclick="showPage('financial')">‚Üê Back to Financial</button>
                    <div>
                        <h1 class="page-title" id="stream-title" style="color: var(--warning);">Stream Name</h1>
                        <p class="page-subtitle" id="stream-subtitle">Edit revenue stream details</p>
                    </div>
                    <div class="btn-group" style="margin-left: auto;">
                        <button class="btn" onclick="addProjectionWeek(); renderStreamDetail(currentStreamId);">+ Add Week</button>
                        <button class="btn" onclick="removeProjectionWeek(); renderStreamDetail(currentStreamId);">- Remove Last</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Revenue (Period)</div>
                        <div class="stat-value success" id="stream-total-revenue">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Weeks</div>
                        <div class="stat-value" id="stream-active-weeks">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Type</div>
                        <div class="stat-value" id="stream-type-badge" style="font-size: 14px;">Fixed</div>
                    </div>
                </div>

                <div class="financial-settings-grid" style="margin-bottom: 24px;">
                    <div class="financial-setting-card">
                        <h4>Stream Details</h4>
                        <div class="financial-input-row">
                            <label>Stream Name</label>
                            <input type="text" class="financial-input" id="stream-name" style="width: 180px;" onchange="updateStreamField('name', this.value)">
                        </div>
                        <div class="financial-input-row">
                            <label>Type</label>
                            <select class="financial-input" id="stream-type" style="width: 160px;" onchange="updateStreamField('type', this.value); renderStreamDetail(currentStreamId);">
                                <option value="fixed">Fixed Monthly</option>
                                <option value="user_based">User-Based</option>
                                <option value="campaign">Campaign-Based</option>
                            </select>
                        </div>
                        <!-- Fixed fields -->
                        <div id="stream-fields-fixed">
                            <div class="financial-input-row">
                                <label>Monthly Amount</label>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="color: var(--text-muted);">$</span>
                                    <input type="number" class="financial-input" id="stream-monthly-amount" style="width: 100px;" onchange="updateStreamField('monthlyAmount', this.value)">
                                </div>
                            </div>
                        </div>
                        <!-- User-based fields -->
                        <div id="stream-fields-user-based" style="display: none;">
                            <div class="financial-input-row">
                                <label>Weekly Price per User</label>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="color: var(--text-muted);">$</span>
                                    <input type="number" class="financial-input" id="stream-weekly-price" style="width: 100px;" step="0.01" onchange="updateStreamField('weeklyPrice', this.value)">
                                </div>
                            </div>
                            <div class="financial-input-row">
                                <label>Conversion Rate (%/mo)</label>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" class="financial-input" id="stream-conversion-rate" style="width: 80px;" step="0.5" onchange="updateStreamField('conversionRate', this.value)">
                                    <span style="color: var(--text-muted);">%</span>
                                </div>
                            </div>
                            <div class="financial-input-row">
                                <label>Churn Rate (%/mo)</label>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" class="financial-input" id="stream-churn-rate" style="width: 80px;" step="0.5" onchange="updateStreamField('churnRate', this.value)">
                                    <span style="color: var(--text-muted);">%</span>
                                </div>
                            </div>
                        </div>
                        <!-- Campaign-based fields -->
                        <div id="stream-fields-campaign" style="display: none;">
                            <div class="financial-input-row">
                                <label>Cost per User</label>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="color: var(--text-muted);">$</span>
                                    <input type="number" class="financial-input" id="stream-cost-per-user" style="width: 100px;" step="0.01" onchange="updateStreamField('costPerUser', this.value)">
                                </div>
                            </div>
                        </div>
                        <div class="financial-input-row">
                            <label>Launch Week</label>
                            <input type="number" class="financial-input" id="stream-launch-week" style="width: 80px;" min="0" max="47" onchange="updateStreamField('launchWeek', this.value)">
                        </div>
                        <div class="financial-input-row">
                            <label>Status</label>
                            <select class="financial-input" id="stream-enabled" style="width: 100px;" onchange="updateStreamField('enabled', this.value === 'true')">
                                <option value="true">Active</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="deleteStreamFromDetail()">
                                Delete Stream
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Monthly plan for campaign-based streams -->
                <div id="stream-monthly-plan-section" style="display: none;">
                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <span class="card-title">Monthly Campaign Plan</span>
                            <span style="font-size: 10px; color: var(--text-muted);">Set activations per month</span>
                        </div>
                        <div style="padding: 16px; overflow-x: auto;">
                            <div id="stream-monthly-plan" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Revenue Timeline -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <span class="card-title">Monthly Revenue Timeline</span>
                        <span style="font-size: 10px; color: var(--text-muted);">Revenue distribution by month</span>
                    </div>
                    <div style="padding: 16px; overflow-x: auto;">
                        <div id="stream-monthly-timeline" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
                    </div>
                </div>
            </div>

            <!-- ==================== PLANNED VS ACTUAL PAGE ==================== -->
            <div class="page" id="page-snapshots">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Planned vs Actual</h1>
                        <p class="page-subtitle">Compare projection snapshots against real numbers</p>
                    </div>
                </div>

                <!-- Snapshots List (manage saved snapshots) -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <span class="card-title">Snapshots</span>
                    </div>
                    <div id="snapshots-list" style="padding: 16px;"></div>
                </div>

                <!-- Comparison Chart -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <span class="card-title">Comparison Chart</span>
                    </div>
                    <div id="comparison-chart-container" style="padding: 20px; min-height: 280px; position: relative;"></div>
                </div>

                <!-- Actuals Entry Table -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Actual Numbers</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="matrix-table" id="actuals-table">
                            <thead id="actuals-head"></thead>
                            <tbody id="actuals-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal-overlay" id="modal-onboarding">
        <div class="modal" style="max-width: 550px;">
            <h3 class="modal-title">Welcome to Growth Model üìà</h3>

            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 20px;">
                This tool helps you plan, track, and iterate on your growth strategy using a <strong>funnel-based model</strong>. Every number is an assumption ‚Äî update them as you learn.
            </p>

            <div class="onboarding-step">
                <span class="onboarding-step-number">1</span>
                <span class="onboarding-step-title">Matrix Overview</span>
                <p class="onboarding-step-desc">
                    See all your acquisition channels in one table. Each row is a channel, each column is a funnel step. <strong>Edit any number directly</strong> ‚Äî changes cascade automatically.
                </p>
            </div>

            <div class="onboarding-step">
                <span class="onboarding-step-number">2</span>
                <span class="onboarding-step-title">Conversion Rates Drive Everything</span>
                <p class="onboarding-step-desc">
                    The <span style="color: var(--warning);">yellow rates (%)</span> are your key levers. Change a rate and watch all downstream numbers recalculate instantly. This is how you model "what if" scenarios.
                </p>
            </div>

            <div class="onboarding-step">
                <span class="onboarding-step-number">3</span>
                <span class="onboarding-step-title">Confidence Indicators</span>
                <p class="onboarding-step-desc">
                    Each channel has a confidence dot: <span style="color: var(--danger);">‚óè</span> Low, <span style="color: var(--warning);">‚óè</span> Medium, <span style="color: var(--success);">‚óè</span> High. Click to cycle. Use this to track which assumptions are validated vs. guesses.
                </p>
            </div>

            <div class="onboarding-step">
                <span class="onboarding-step-number">4</span>
                <span class="onboarding-step-title">Channel Details</span>
                <p class="onboarding-step-desc">
                    Click any channel row to open the full funnel view. Here you can rename steps, add/remove funnel stages, and keep notes about what you've learned.
                </p>
            </div>

            <div class="onboarding-step">
                <span class="onboarding-step-number">5</span>
                <span class="onboarding-step-title">Scenarios</span>
                <p class="onboarding-step-desc">
                    Use <strong>Base / Conservative / Optimistic</strong> toggle to stress-test your model. Conservative applies 0.7√ó to all rates, Optimistic applies 1.3√ó.
                </p>
            </div>

            <div class="onboarding-tip">
                <strong>üí° Pro tip:</strong> Your model is saved automatically to your browser. Use <strong>Export JSON</strong> to backup your data or share it with your team.
            </div>

            <div class="onboarding-footer">
                <label class="onboarding-checkbox">
                    <input type="checkbox" id="dont-show-again">
                    Don't show this again
                </label>
                <button class="btn btn-primary" onclick="closeOnboarding()">Got it, let's go!</button>
            </div>
        </div>
    </div>

    <!-- Add Channel Modal -->
    <div class="modal-overlay" id="modal-add-channel">
        <div class="modal">
            <h3 class="modal-title">Add New Channel</h3>
            <div class="form-group">
                <label class="form-label">Channel Name</label>
                <input type="text" class="form-input" id="new-channel-name" placeholder="e.g., Twitter Spaces">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="new-channel-desc" placeholder="e.g., Weekly webinars with target audience">
            </div>
            <div class="form-group">
                <label class="form-label">Platform</label>
                <div class="btn-group" id="new-channel-platform">
                    <!-- Populated dynamically from data.platforms -->
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Initial Confidence</label>
                <div class="confidence-selector" id="new-channel-confidence">
                    <div class="confidence-option low" data-conf="low" onclick="selectNewConf('low')"></div>
                    <div class="confidence-option medium selected" data-conf="medium" onclick="selectNewConf('medium')"></div>
                    <div class="confidence-option high" data-conf="high" onclick="selectNewConf('high')"></div>
                </div>
            </div>
            <div class="btn-group" style="justify-content: flex-end; margin-top: 16px;">
                <button class="btn" onclick="closeModal('modal-add-channel')">Cancel</button>
                <button class="btn btn-primary" onclick="addChannel()">Add Channel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Phase Modal -->
    <div class="modal-overlay" id="modal-phase">
        <div class="modal">
            <h3 class="modal-title" id="modal-phase-title">Add Phase</h3>
            <input type="hidden" id="edit-phase-id">
            <div class="form-group">
                <label class="form-label">Phase Name</label>
                <input type="text" class="form-input" id="phase-name" placeholder="e.g., Launch Week">
            </div>
            <div class="form-group">
                <label class="form-label">Dates</label>
                <input type="text" class="form-input" id="phase-dates" placeholder="e.g., Week 1-2">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="phase-description" placeholder="e.g., Initial launch activities">
            </div>
            <div class="form-group">
                <label class="form-label">Emoji</label>
                <input type="text" class="form-input" id="phase-emoji" placeholder="e.g., üöÄ" style="width: 80px;">
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <select class="form-input" id="phase-color">
                    <option value="var(--accent)">Blue (Accent)</option>
                    <option value="var(--success)">Green (Success)</option>
                    <option value="var(--warning)">Yellow (Warning)</option>
                    <option value="var(--danger)">Red (Danger)</option>
                    <option value="var(--text-muted)">Gray (Muted)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Assign Channels</label>
                <div id="phase-channels" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>
            <div class="btn-group" style="justify-content: flex-end; margin-top: 16px;">
                <button class="btn" onclick="closeModal('modal-phase')">Cancel</button>
                <button class="btn btn-primary" onclick="savePhase()">Save Phase</button>
            </div>
        </div>
    </div>

    <!-- Manage Platforms Modal -->
    <div class="modal-overlay" id="modal-platforms">
        <div class="modal">
            <h3 class="modal-title">Manage Platforms</h3>
            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                Define the platforms your channels can target.
            </p>
            <div id="platforms-list" style="margin-bottom: 12px;"></div>
            <div style="display: flex; gap: 8px;">
                <input type="text" class="form-input" id="new-platform-name" placeholder="e.g., mobile, desktop, ios">
                <button class="btn btn-primary btn-sm" onclick="addPlatform()">Add</button>
            </div>
            <div class="btn-group" style="justify-content: flex-end; margin-top: 16px;">
                <button class="btn btn-primary" onclick="closeModal('modal-platforms')">Done</button>
            </div>
        </div>
    </div>

    <!-- Generic Modal (for alert/confirm/prompt replacements) -->
    <div class="modal-overlay" id="modal-generic">
        <div class="modal" style="max-width: 420px;">
            <h3 class="modal-title" id="modal-generic-title"></h3>
            <div id="modal-generic-body"></div>
            <div id="modal-generic-actions" style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span style="color: var(--success);">‚úì</span>
        <span id="toast-message">Saved</span>
    </div>

    <script>
        // =====================================================
        // GENERIC MODAL SYSTEM (replaces alert/confirm/prompt)
        // =====================================================
        function _showGenericModal(title, bodyHtml, actionsHtml) {
            document.getElementById('modal-generic-title').textContent = title;
            document.getElementById('modal-generic-body').innerHTML = bodyHtml;
            document.getElementById('modal-generic-actions').innerHTML = actionsHtml;
            document.getElementById('modal-generic').classList.add('show');
        }

        function _closeGenericModal() {
            document.getElementById('modal-generic').classList.remove('show');
        }

        function showAlert(message, title = 'Notice') {
            return new Promise(resolve => {
                _showGenericModal(title,
                    `<p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">${message}</p>`,
                    `<button class="btn btn-primary" id="modal-generic-ok">OK</button>`
                );
                document.getElementById('modal-generic-ok').onclick = () => { _closeGenericModal(); resolve(); };
            });
        }

        function showConfirm(message, title = 'Confirm') {
            return new Promise(resolve => {
                _showGenericModal(title,
                    `<p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">${message}</p>`,
                    `<button class="btn" id="modal-generic-cancel">Cancel</button>
                     <button class="btn btn-primary" id="modal-generic-confirm" style="background: var(--danger);">Confirm</button>`
                );
                document.getElementById('modal-generic-cancel').onclick = () => { _closeGenericModal(); resolve(false); };
                document.getElementById('modal-generic-confirm').onclick = () => { _closeGenericModal(); resolve(true); };
            });
        }

        function showPrompt(label, defaultVal = '', title = 'Input') {
            return new Promise(resolve => {
                _showGenericModal(title,
                    `<div class="form-group">
                        <label class="form-label">${label}</label>
                        <input type="text" class="form-input" id="modal-generic-input" value="${defaultVal.replace(/"/g, '&quot;')}">
                    </div>`,
                    `<button class="btn" id="modal-generic-cancel">Cancel</button>
                     <button class="btn btn-primary" id="modal-generic-ok">OK</button>`
                );
                const input = document.getElementById('modal-generic-input');
                input.focus();
                input.select();
                input.addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('modal-generic-ok').click(); });
                document.getElementById('modal-generic-cancel').onclick = () => { _closeGenericModal(); resolve(null); };
                document.getElementById('modal-generic-ok').onclick = () => { _closeGenericModal(); resolve(input.value); };
            });
        }

        function showMultiPrompt(fields, title = 'Input') {
            return new Promise(resolve => {
                let fieldsHtml = fields.map(f => {
                    if (f.type === 'select') {
                        const options = f.options.map(o => `<option value="${o.value}" ${o.value === f.default ? 'selected' : ''}>${o.label}</option>`).join('');
                        return `<div class="form-group">
                            <label class="form-label">${f.label}</label>
                            <select class="form-input" data-field="${f.key}" id="mp-${f.key}">${options}</select>
                        </div>`;
                    }
                    return `<div class="form-group" id="mp-group-${f.key}" ${f.hidden ? 'style="display:none;"' : ''}>
                        <label class="form-label">${f.label}</label>
                        <input type="${f.type || 'text'}" class="form-input" data-field="${f.key}" id="mp-${f.key}"
                               value="${(f.default || '').toString().replace(/"/g, '&quot;')}" ${f.step ? `step="${f.step}"` : ''} ${f.min != null ? `min="${f.min}"` : ''} ${f.max != null ? `max="${f.max}"` : ''} placeholder="${f.placeholder || ''}">
                    </div>`;
                }).join('');

                _showGenericModal(title, fieldsHtml,
                    `<button class="btn" id="modal-generic-cancel">Cancel</button>
                     <button class="btn btn-primary" id="modal-generic-ok">Create</button>`
                );

                // Wire up dynamic show/hide for type selector
                const typeSelect = document.getElementById('mp-type');
                if (typeSelect) {
                    const updateVisibility = () => {
                        const val = typeSelect.value;
                        fields.forEach(f => {
                            if (f.showWhen) {
                                const group = document.getElementById('mp-group-' + f.key);
                                if (group) group.style.display = f.showWhen.includes(val) ? '' : 'none';
                            }
                        });
                    };
                    typeSelect.addEventListener('change', updateVisibility);
                    updateVisibility();
                }

                const firstInput = document.querySelector('#modal-generic-body input');
                if (firstInput) { firstInput.focus(); firstInput.select(); }

                document.getElementById('modal-generic-cancel').onclick = () => { _closeGenericModal(); resolve(null); };
                document.getElementById('modal-generic-ok').onclick = () => {
                    const result = {};
                    fields.forEach(f => {
                        const el = document.getElementById('mp-' + f.key);
                        if (el) result[f.key] = el.value;
                    });
                    _closeGenericModal();
                    resolve(result);
                };
            });
        }

        // =====================================================
        // DATA MODEL - Default example data (replace with your own)
        // Load from data.json or use these defaults
        // =====================================================
        let data = {
            meta: {
                current: 500,
                target: 5000,
                deadline: "2026-06-30",
                lastUpdated: new Date().toISOString()
            },
            scenario: 1,
            channels: [
                // === EXAMPLE CHANNELS - Replace with your own ===
                {
                    id: 'organic_social',
                    name: 'Organic Social',
                    description: 'Twitter/X + LinkedIn content strategy',
                    platform: 'both',
                    confidence: 'medium',
                    funnel: [
                        { label: 'Impressions', value: 100000, rate: null },
                        { label: 'Engagement', value: 3000, rate: 3 },
                        { label: 'Profile Visits', value: 1500, rate: 50 },
                        { label: 'Link Clicks', value: 450, rate: 30 },
                        { label: 'Signups', value: 135, rate: 30 },
                        { label: 'Activated', value: 95, rate: 70 }
                    ],
                    notes: ['Post 3x/week on Twitter', 'Focus on educational content']
                },
                {
                    id: 'content_marketing',
                    name: 'Content Marketing',
                    description: 'Blog posts + SEO',
                    platform: 'app',
                    confidence: 'medium',
                    funnel: [
                        { label: 'Monthly Visitors', value: 10000, rate: null },
                        { label: 'Read Article', value: 4000, rate: 40 },
                        { label: 'Click CTA', value: 400, rate: 10 },
                        { label: 'Signups', value: 120, rate: 30 },
                        { label: 'Activated', value: 84, rate: 70 }
                    ],
                    notes: ['2 blog posts per week', 'Target long-tail keywords']
                },
                {
                    id: 'newsletter',
                    name: 'Newsletter',
                    description: 'Email list growth + nurture',
                    platform: 'both',
                    confidence: 'high',
                    funnel: [
                        { label: 'Subscribers', value: 5000, rate: null },
                        { label: 'Open Email', value: 1500, rate: 30 },
                        { label: 'Click CTA', value: 300, rate: 20 },
                        { label: 'Signups', value: 90, rate: 30 },
                        { label: 'Activated', value: 72, rate: 80 }
                    ],
                    notes: ['Weekly newsletter', 'A/B test subject lines']
                },
                {
                    id: 'paid_ads',
                    name: 'Paid Ads',
                    description: 'Google Ads + Meta Ads',
                    platform: 'app',
                    confidence: 'low',
                    funnel: [
                        { label: 'Ad Spend', value: 5000, rate: null },
                        { label: 'Impressions', value: 500000, rate: null },
                        { label: 'Clicks', value: 5000, rate: 1 },
                        { label: 'Signups', value: 250, rate: 5 },
                        { label: 'Activated', value: 125, rate: 50 }
                    ],
                    notes: ['$5K monthly budget', 'Focus on retargeting']
                },
                {
                    id: 'referral',
                    name: 'Referral Program',
                    description: 'User referral loop',
                    platform: 'app',
                    confidence: 'low',
                    funnel: [
                        { label: 'Active Users', value: 500, rate: null },
                        { label: 'Users Share', value: 50, rate: 10 },
                        { label: 'Invites Sent', value: 150, rate: 300 },
                        { label: 'Invite Clicks', value: 75, rate: 50 },
                        { label: 'Signups', value: 38, rate: 50 },
                        { label: 'Activated', value: 30, rate: 80 }
                    ],
                    notes: ['Referral reward: 1 month free', 'K-factor goal: 0.15']
                },
                {
                    id: 'partnerships',
                    name: 'Partnerships',
                    description: 'Co-marketing with complementary products',
                    platform: 'both',
                    confidence: 'low',
                    funnel: [
                        { label: 'Partners', value: 5, rate: null },
                        { label: 'Combined Reach', value: 50000, rate: null },
                        { label: 'Impressions', value: 10000, rate: 20 },
                        { label: 'Clicks', value: 300, rate: 3 },
                        { label: 'Signups', value: 90, rate: 30 },
                        { label: 'Activated', value: 63, rate: 70 }
                    ],
                    notes: ['Target 2 new partners per month', 'Focus on audience overlap']
                }
            ],
            weekly: [
                { id: 'w1', name: 'Week 1', dates: 'Week 1', target: 100, actual: null, current: true, note: 'Launch week' },
                { id: 'w2', name: 'Week 2', dates: 'Week 2', target: 150, actual: null, current: false, note: 'Paid ads start' },
                { id: 'w3', name: 'Week 3', dates: 'Week 3', target: 200, actual: null, current: false, note: 'Content ramp up' },
                { id: 'w4', name: 'Week 4', dates: 'Week 4', target: 250, actual: null, current: false, note: 'Month 1 target' },
                { id: 'w5', name: 'Week 5', dates: 'Week 5', target: 300, actual: null, current: false, note: 'Referral launch' },
                { id: 'w6', name: 'Week 6', dates: 'Week 6', target: 350, actual: null, current: false, note: 'Partnership push' },
                { id: 'w7', name: 'Week 7', dates: 'Week 7', target: 400, actual: null, current: false, note: 'Optimize channels' },
                { id: 'w8', name: 'Week 8', dates: 'Week 8', target: 450, actual: null, current: false, note: 'Month 2 target' }
            ],
            projection: {
                settings: {
                    startUsers: 500,
                    organicRate: 2,      // Weekly organic growth rate %
                    churnRate: 1,        // Weekly churn rate %
                    kFactor: 0.05        // Viral coefficient
                },
                weeks: [
                    { id: 'w0', name: 'W1', month: 1, note: 'Launch' },
                    { id: 'w1', name: 'W2', month: 1, note: 'Week 2' },
                    { id: 'w2', name: 'W3', month: 1, note: 'Week 3' },
                    { id: 'w3', name: 'W4', month: 1, note: 'Month 1' },
                    { id: 'w4', name: 'W5', month: 2, note: 'Week 5' },
                    { id: 'w5', name: 'W6', month: 2, note: 'Week 6' },
                    { id: 'w6', name: 'W7', month: 2, note: 'Week 7' },
                    { id: 'w7', name: 'W8', month: 2, note: 'Month 2' }
                ],
                channelMultipliers: {
                    'organic_social': [0.2, 0.2, 0.15, 0.15, 0.1, 0.1, 0.05, 0.05],
                    'content_marketing': [0.1, 0.1, 0.15, 0.15, 0.15, 0.15, 0.1, 0.1],
                    'newsletter': [0.1, 0.15, 0.15, 0.15, 0.15, 0.1, 0.1, 0.1],
                    'paid_ads': [0, 0.3, 0.2, 0.2, 0.1, 0.1, 0.05, 0.05],
                    'referral': [0, 0, 0.1, 0.15, 0.2, 0.2, 0.2, 0.15],
                    'partnerships': [0, 0, 0, 0.2, 0.2, 0.2, 0.2, 0.2]
                }
            },
            notes: [
                { date: new Date().toISOString(), text: 'Example data - replace with your own growth model' },
                { date: new Date().toISOString(), text: 'Edit any value directly - changes auto-save' }
            ],
            // Timeline phases - assign channels to phases
            phases: [
                {
                    id: 'phase1',
                    name: 'Launch Week',
                    dates: 'Week 1',
                    emoji: 'üöÄ',
                    color: 'var(--accent)',
                    description: 'Initial launch activities',
                    channels: ['organic_social', 'content_marketing']
                },
                {
                    id: 'phase2',
                    name: 'Growth Phase',
                    dates: 'Week 2-4',
                    emoji: 'üìà',
                    color: 'var(--success)',
                    description: 'Paid acquisition and partnerships kick off',
                    channels: ['newsletter', 'paid_ads', 'partnerships']
                },
                {
                    id: 'phase3',
                    name: 'Scale Phase',
                    dates: 'Week 5+',
                    emoji: 'üéØ',
                    color: 'var(--warning)',
                    description: 'Referral loop and optimization',
                    channels: ['referral']
                }
            ],
            // Available platforms
            platforms: ['app', 'web', 'both']
        };

        let currentChannel = null;
        let newChannelConf = 'medium';
        let newChannelPlatform = 'both';
        let theme = 'dark';

        // =====================================================
        // THEME
        // =====================================================
        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('growth-model-theme', theme);
        }

        function loadTheme() {
            const saved = localStorage.getItem('growth-model-theme');
            if (saved) {
                theme = saved;
                document.documentElement.setAttribute('data-theme', theme);
                document.getElementById('theme-icon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Track expanded channels
        const expandedChannels = new Set();

        function toggleChannelExpand(channelId) {
            const details = document.getElementById('channel-details-' + channelId);
            const icon = document.getElementById('expand-icon-' + channelId);
            if (!details || !icon) return;

            if (expandedChannels.has(channelId)) {
                expandedChannels.delete(channelId);
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            } else {
                expandedChannels.add(channelId);
                details.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
            }
        }

        // =====================================================
        // ONBOARDING
        // =====================================================
        function showOnboarding() {
            document.getElementById('modal-onboarding').classList.add('show');
        }

        function closeOnboarding() {
            const dontShow = document.getElementById('dont-show-again').checked;
            if (dontShow) {
                localStorage.setItem('growth-model-onboarding-seen', 'true');
            }
            document.getElementById('modal-onboarding').classList.remove('show');
        }

        function checkOnboarding() {
            const seen = localStorage.getItem('growth-model-onboarding-seen');
            if (!seen) {
                showOnboarding();
            }
        }

        // =====================================================
        // CALCULATIONS
        // =====================================================
        function calcChannel(channel) {
            const result = { steps: [] };
            let prev = null;
            const scenarioMultiplier = data.scenario || 1; // Default to 1 if null

            channel.funnel.forEach((step, i) => {
                let value;
                if (i === 0) {
                    value = step.value;
                } else {
                    const rate = (step.rate || 0) * scenarioMultiplier;
                    value = Math.round(prev * (rate / 100));
                }
                result.steps.push({ ...step, calcValue: value });
                prev = value;
            });

            result.activations = result.steps[result.steps.length - 1].calcValue;
            return result;
        }

        function calcTotals() {
            let total = 0;
            data.channels.forEach(ch => {
                total += calcChannel(ch).activations;
            });
            return total;
        }

        // =====================================================
        // RENDER - SIDEBAR
        // =====================================================
        function renderSidebar() {
            const total = calcTotals();
            const gap = data.meta.target - data.meta.current;
            const coverage = Math.round((total / gap) * 100);

            // Calculate platform totals dynamically
            let plat = {};
            data.platforms.forEach(p => plat[p] = 0);
            data.channels.forEach(ch => {
                const p = ch.platform || data.platforms[0] || 'web';
                plat[p] = (plat[p] || 0) + calcChannel(ch).activations;
            });

            document.getElementById('sidebar-summary').innerHTML = `
                <div class="sidebar-summary-row" style="font-size: 9px; color: var(--text-muted); padding-bottom: 4px;">CURRENT STATE</div>
                <div class="sidebar-summary-row">
                    <span>üë• Current</span>
                    <input type="number" class="sidebar-editable" value="${data.meta.current || 0}"
                           onchange="updateMeta('current', parseInt(this.value) || 0)"
                           style="width: 70px; text-align: right; color: var(--accent);">
                </div>
                <div class="sidebar-summary-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); font-size: 9px; color: var(--text-muted); padding-bottom: 4px;">TARGET</div>
                <div class="sidebar-summary-row">
                    <span>üéØ Goal</span>
                    <input type="number" class="sidebar-editable" value="${data.meta.target || 0}"
                           onchange="updateMeta('target', parseInt(this.value) || 0)"
                           style="width: 70px; text-align: right;">
                </div>
                <div class="sidebar-summary-row">
                    <span>üìÖ Deadline</span>
                    <input type="date" class="sidebar-editable" value="${data.meta.deadline || ''}"
                           onchange="updateMeta('deadline', this.value)"
                           style="width: 110px; text-align: right;">
                </div>
                <div class="sidebar-summary-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); font-size: 9px; color: var(--text-muted); padding-bottom: 4px;">MODEL OUTPUT</div>
                <div class="sidebar-summary-row highlight">
                    <span>+New Users</span>
                    <span>${fmt(total)}</span>
                </div>
                <div class="sidebar-summary-row">
                    <span>Projected Total</span>
                    <span style="color: var(--success);">${fmt(data.meta.current + total)}</span>
                </div>
                <div class="sidebar-summary-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); font-size: 9px; color: var(--text-muted); padding-bottom: 4px;">GAP COVERAGE</div>
                <div class="sidebar-summary-row">
                    <span>Gap (${fmt(gap)} needed)</span>
                    <span style="color: ${coverage >= 100 ? 'var(--success)' : 'var(--warning)'}">${coverage}%</span>
                </div>
            `;

            const defaultViewOrder = ['matrix', 'activations', 'projection', 'snapshots', 'weekmatrix', 'financial'];
            const viewMeta = {
                matrix: { label: 'Matrix Overview' },
                activations: { label: 'Activations Timeline' },
                projection: { label: 'Time Projection' },
                snapshots: { label: 'Planned vs Actual' },
                weekmatrix: { label: 'Week Matrix' },
                financial: { label: 'üí∞ Financial', style: 'color: var(--success);' }
            };
            let viewOrder = JSON.parse(localStorage.getItem('growthmodel_viewOrder') || 'null') || [...defaultViewOrder];
            defaultViewOrder.forEach(v => { if (!viewOrder.includes(v)) viewOrder.push(v); });
            viewOrder = viewOrder.filter(v => defaultViewOrder.includes(v));

            const viewsHtml = viewOrder.map((pageId, idx) => {
                const meta = viewMeta[pageId];
                const styleAttr = meta.style ? ` style="${meta.style}"` : '';
                return `
                    <div class="nav-item" data-page="${pageId}" onclick="showPage('${pageId}')"${styleAttr}>
                        <div class="channel-reorder">
                            <button class="reorder-btn" onclick="event.stopPropagation(); moveView('${pageId}', -1)" ${idx === 0 ? 'disabled' : ''}>‚ñ≤</button>
                            <button class="reorder-btn" onclick="event.stopPropagation(); moveView('${pageId}', 1)" ${idx === viewOrder.length - 1 ? 'disabled' : ''}>‚ñº</button>
                        </div>
                        ${meta.label}
                    </div>`;
            }).join('');

            document.getElementById('sidebar-nav').innerHTML = `
                <div class="nav-section">
                    <div class="nav-section-title">Views</div>
                    ${viewsHtml}
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">
                        Channels
                        <button class="nav-add-btn" onclick="openAddChannelModal()">+</button>
                    </div>
                    ${data.channels.map((ch, idx) => {
                        const act = calcChannel(ch).activations;
                        return `
                            <div class="nav-item" data-page="channel" data-channel="${ch.id}">
                                <div class="channel-reorder">
                                    <button class="reorder-btn" onclick="event.stopPropagation(); moveChannel('${ch.id}', -1)" ${idx === 0 ? 'disabled' : ''}>‚ñ≤</button>
                                    <button class="reorder-btn" onclick="event.stopPropagation(); moveChannel('${ch.id}', 1)" ${idx === data.channels.length - 1 ? 'disabled' : ''}>‚ñº</button>
                                </div>
                                <span class="confidence-dot confidence-${ch.confidence}" onclick="showPage('channel', '${ch.id}')"></span>
                                <span class="channel-name" onclick="showPage('channel', '${ch.id}')">${ch.name}</span>
                                <span style="font-size: 10px; opacity: 0.7;" onclick="showPage('channel', '${ch.id}')">${ch.platform || 'web'}</span>
                                <span class="nav-item-target" onclick="showPage('channel', '${ch.id}')">${fmt(act)}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // =====================================================
        // RENDER - MATRIX PAGE
        // =====================================================
        function renderMatrix() {
            const total = calcTotals();
            const gap = data.meta.target - data.meta.current;
            const coverage = Math.round((total / gap) * 100);

            document.getElementById('matrix-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">
                        <div class="tooltip-wrapper">
                            üë• Current
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                <strong>Current Users</strong>
                                Your current user base before applying growth channels.
                            </div>
                        </div>
                    </div>
                    <div class="stat-value" style="color: var(--accent);">${fmt(data.meta.current || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <div class="tooltip-wrapper">
                            üéØ Target
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                <strong>Target Users</strong>
                                Your goal for total active users by the deadline.
                            </div>
                        </div>
                    </div>
                    <div class="stat-value">${fmt(data.meta.target)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <div class="tooltip-wrapper">
                            Gap
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                <strong>Gap to Target</strong>
                                Users needed to reach target. Formula: Target - Current.
                            </div>
                        </div>
                    </div>
                    <div class="stat-value warning">${fmt(gap)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <div class="tooltip-wrapper">
                            +Model Output
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                <strong>Model Output</strong>
                                Total new users projected from all growth channels combined.
                            </div>
                        </div>
                    </div>
                    <div class="stat-value success">${fmt(total)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <div class="tooltip-wrapper">
                            Projected
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                <strong>Projected Total</strong>
                                Expected final user count. Formula: Current + Model Output.
                            </div>
                        </div>
                    </div>
                    <div class="stat-value success">${fmt(data.meta.current + total)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <div class="tooltip-wrapper">
                            Coverage
                            <span class="tooltip-icon">?</span>
                            <div class="tooltip-content">
                                <strong>Gap Coverage</strong>
                                How much of the gap is covered by model output. 100%+ means on track. Formula: (Model Output / Gap) √ó 100.
                            </div>
                        </div>
                    </div>
                    <div class="stat-value ${coverage >= 100 ? 'success' : 'warning'}">${coverage}%</div>
                </div>
            `;

            const maxSteps = Math.max(...data.channels.map(ch => ch.funnel.length));

            let headerHtml = '<tr><th>Channel</th>';
            for (let i = 0; i < maxSteps; i++) {
                if (i === 0) {
                    headerHtml += `<th>Top of Funnel</th>`;
                } else {
                    headerHtml += `<th>Rate ${i} (%)</th><th>Step ${i}</th>`;
                }
            }
            headerHtml += '</tr>';
            document.getElementById('matrix-head').innerHTML = headerHtml;

            let bodyHtml = '';
            let totals = { top: 0 };
            for (let i = 1; i < maxSteps; i++) totals['step' + i] = 0;

            // Platform totals - dynamically from data.platforms
            let platformTotals = {};
            data.platforms.forEach(p => platformTotals[p] = 0);

            // Platform color mapping
            const platformColorMap = ['var(--accent)', 'var(--success)', 'var(--warning)', 'var(--danger)', 'var(--text-muted)'];

            data.channels.forEach(ch => {
                const calc = calcChannel(ch);
                const platformIdx = data.platforms.indexOf(ch.platform);
                const platformColor = platformColorMap[platformIdx >= 0 ? platformIdx % platformColorMap.length : 0];

                bodyHtml += `<tr onclick="showPage('channel', '${ch.id}')">`;

                bodyHtml += `
                    <td>
                        <div class="channel-cell">
                            <span class="confidence-dot confidence-${ch.confidence}"
                                  onclick="event.stopPropagation(); cycleConf('${ch.id}')"
                                  style="cursor: pointer;"></span>
                            <span class="channel-cell-name">${ch.name}</span>
                            <span style="font-size: 9px; padding: 1px 4px; border-radius: 3px; background: ${platformColor}20; color: ${platformColor}; margin-left: 4px;">${ch.platform || data.platforms[0] || 'web'}</span>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteChannel('${ch.id}')">&times;</button>
                        </div>
                    </td>
                `;

                // Track platform totals
                const p = ch.platform || data.platforms[0] || 'web';
                platformTotals[p] = (platformTotals[p] || 0) + calc.activations;

                calc.steps.forEach((step, i) => {
                    if (i === 0) {
                        bodyHtml += `
                            <td onclick="event.stopPropagation()">
                                <input type="number" class="matrix-editable"
                                       value="${ch.funnel[i].value}"
                                       onchange="updateFunnel('${ch.id}', ${i}, 'value', this.value)"
                                       title="${step.label}">
                            </td>
                        `;
                        totals.top += step.calcValue;
                    } else {
                        bodyHtml += `
                            <td onclick="event.stopPropagation()">
                                <input type="number" class="matrix-editable rate"
                                       value="${ch.funnel[i].rate || 0}"
                                       step="0.1"
                                       onchange="updateFunnel('${ch.id}', ${i}, 'rate', this.value)">
                            </td>
                        `;
                        const isLast = i === calc.steps.length - 1;
                        bodyHtml += `
                            <td>
                                <span class="calculated ${isLast ? 'final' : ''}" title="${step.label}">
                                    ${fmt(step.calcValue)}
                                </span>
                            </td>
                        `;
                        totals['step' + i] = (totals['step' + i] || 0) + step.calcValue;
                    }
                });

                const stepsNeeded = (maxSteps - ch.funnel.length) * 2;
                for (let j = 0; j < stepsNeeded; j++) {
                    bodyHtml += '<td>-</td>';
                }

                bodyHtml += '</tr>';
            });

            // Platform subtotal rows - dynamically rendered
            const grandTotal = Object.values(platformTotals).reduce((a, b) => a + b, 0);

            // Show platform breakdown
            data.platforms.forEach((platform, idx) => {
                const color = platformColorMap[idx % platformColorMap.length];
                bodyHtml += `<tr style="background: var(--bg-secondary); ${idx === 0 ? 'border-top: 2px solid var(--border);' : ''}">
                    <td style="color: ${color};"><strong>${platform}</strong></td>
                    <td colspan="${maxSteps * 2 - 1}" style="text-align: left; padding-left: 20px;">
                        <span style="color: ${color}; font-weight: 600;">${fmt(platformTotals[platform] || 0)}</span>
                    </td>
                </tr>`;
            });

            bodyHtml += `<tr class="totals-row">
                <td><strong>TOTAL</strong></td>
                <td colspan="${maxSteps * 2 - 1}" style="text-align: left; padding-left: 20px;">
                    <span class="calculated final" style="font-size: 16px;">${fmt(grandTotal)}</span>
                </td>
            </tr>`;

            document.getElementById('matrix-body').innerHTML = bodyHtml;
            renderGlobalNotes();
        }

        function renderGlobalNotes() {
            const container = document.getElementById('global-notes');
            if (data.notes.length === 0) {
                container.innerHTML = '<div class="empty-state">No notes yet</div>';
            } else {
                container.innerHTML = data.notes.map((note, i) => `
                    <div class="note-item">
                        <div class="note-item-header">
                            <span>${note.date}</span>
                            <button class="delete-btn" style="opacity: 1;" onclick="deleteGlobalNote(${i})">&times;</button>
                        </div>
                        <div class="note-item-content">${note.text}</div>
                    </div>
                `).join('');
            }
        }

        // =====================================================
        // RENDER - CHANNEL TIMELINE (inline)
        // =====================================================
        function renderChannelTimelineHTML(ch, calc) {
            const maxActivations = calc.activations;
            const multipliers = data.projection.channelMultipliers[ch.id] || [];
            const months = [...new Set(data.projection.weeks.map(w => w.month))];
            const totalProjected = multipliers.reduce((sum, m) => sum + Math.round(maxActivations * m), 0);
            const avgMultiplier = multipliers.length > 0 ? (multipliers.reduce((a, b) => a + b, 0) / multipliers.length).toFixed(2) : '0';

            // Find which phase(s) this channel belongs to
            const channelPhases = (data.phases || []).filter(p => p.channels && p.channels.includes(ch.id));
            const phaseInfo = channelPhases.length > 0
                ? channelPhases.map(p => '<span style="color: ' + (p.color || 'var(--accent)') + ';">' + (p.emoji || '') + ' ' + p.name + ' <span style="color: var(--text-muted); font-size: 10px;">(' + (p.dates || '') + ')</span></span>').join(', ')
                : '<span style="color: var(--text-muted);">Not assigned to any phase</span>';

            return '<div class="card">' +
                '<div class="card-header">' +
                    '<span class="card-title">Activation Timeline</span>' +
                    '<span class="badge badge-draft">Editable</span>' +
                '</div>' +
                '<div style="display: flex; gap: 16px; align-items: center; margin-bottom: 12px; flex-wrap: wrap;">' +
                    '<div style="font-size: 11px;">Phase: ' + phaseInfo + '</div>' +
                    '<div style="font-size: 11px; color: var(--text-muted);">Max from funnel: <strong style="color: var(--text-primary);">' + fmt(maxActivations) + '</strong></div>' +
                    '<div style="font-size: 11px; color: var(--text-muted);">Total projected: <strong style="color: var(--success);">' + fmt(totalProjected) + '</strong></div>' +
                    '<div style="font-size: 11px; color: var(--text-muted);">Avg multiplier: <strong style="color: var(--text-primary);">' + avgMultiplier + 'x</strong></div>' +
                '</div>' +
                '<p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">' +
                    'Set what % of max activations (' + fmt(maxActivations) + ') happens each week. Example: 0.5 = 50% = ' + fmt(Math.round(maxActivations * 0.5)) + ' users' +
                '</p>' +
                '<div style="overflow-x: auto;">' +
                    '<table class="matrix-table">' +
                        '<thead>' +
                            '<tr>' +
                                '<th></th>' +
                                months.map(function(m) {
                                    var weeksInMonth = data.projection.weeks.filter(function(w) { return w.month === m; }).length;
                                    return '<th colspan="' + weeksInMonth + '" style="text-align: center; background: var(--bg-hover);">Month ' + m + '</th>';
                                }).join('') +
                            '</tr>' +
                            '<tr>' +
                                '<th>Metric</th>' +
                                data.projection.weeks.map(function(w) { return '<th>' + w.name + '</th>'; }).join('') +
                            '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                            '<tr>' +
                                '<td>Multiplier</td>' +
                                data.projection.weeks.map(function(w, i) {
                                    return '<td><input type="number" class="matrix-editable rate" value="' + (multipliers[i] || 0) + '" step="0.05" min="0" max="1" style="width: 55px;" onchange="updateChannelMultiplier(\'' + ch.id + '\', ' + i + ', this.value)"></td>';
                                }).join('') +
                            '</tr>' +
                            '<tr>' +
                                '<td style="font-weight: 600;">Activations</td>' +
                                data.projection.weeks.map(function(w, i) {
                                    var act = Math.round(maxActivations * (multipliers[i] || 0));
                                    return '<td style="font-weight: 600; color: var(--success);">' + fmt(act) + '</td>';
                                }).join('') +
                            '</tr>' +
                        '</tbody>' +
                    '</table>' +
                '</div>' +
                '<div class="btn-group" style="flex-wrap: wrap; margin-top: 12px;">' +
                    '<button class="btn btn-sm" onclick="applyPreset(\'' + ch.id + '\', \'launch\')">Launch Spike</button>' +
                    '<button class="btn btn-sm" onclick="applyPreset(\'' + ch.id + '\', \'steady\')">Steady State</button>' +
                    '<button class="btn btn-sm" onclick="applyPreset(\'' + ch.id + '\', \'ramp\')">Slow Ramp</button>' +
                    '<button class="btn btn-sm" onclick="applyPreset(\'' + ch.id + '\', \'oneshot\')">One-Shot</button>' +
                    '<button class="btn btn-sm" onclick="applyPreset(\'' + ch.id + '\', \'zero\')">Zero All</button>' +
                '</div>' +
            '</div>';
        }

        // =====================================================
        // RENDER - CHANNEL DETAIL
        // =====================================================
        function renderChannel(channelId) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;

            currentChannel = channelId;
            const calc = calcChannel(ch);

            document.getElementById('channel-title').textContent = ch.name;
            document.getElementById('channel-subtitle').textContent = ch.description;

            const maxVal = Math.max(...calc.steps.map(s => s.calcValue));

            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Activations</div>
                        <div class="stat-value success">${fmt(calc.activations)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Top of Funnel</div>
                        <div class="stat-value">${fmt(calc.steps[0].calcValue)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Overall Rate</div>
                        <div class="stat-value">${((calc.activations / calc.steps[0].calcValue) * 100).toFixed(2)}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Platform</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;">
                            ${data.platforms.map(p => `
                                <button class="btn btn-sm ${ch.platform === p ? 'btn-primary' : ''}"
                                        style="${ch.platform === p ? '' : 'opacity: 0.5;'}"
                                        onclick="setPlatform('${ch.id}', '${p}')">${p}</button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Confidence</div>
                        <div class="confidence-selector" style="margin-top: 6px;">
                            <div class="confidence-option low ${ch.confidence === 'low' ? 'selected' : ''}" onclick="setConf('${ch.id}', 'low')"></div>
                            <div class="confidence-option medium ${ch.confidence === 'medium' ? 'selected' : ''}" onclick="setConf('${ch.id}', 'medium')"></div>
                            <div class="confidence-option high ${ch.confidence === 'high' ? 'selected' : ''}" onclick="setConf('${ch.id}', 'high')"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Conversion Funnel</span>
                        <span class="badge badge-draft">Editable</span>
                    </div>
                    <div class="funnel">
                        ${calc.steps.map((step, i) => `
                            <div class="funnel-step">
                                <div class="funnel-step-label">
                                    <input type="text" class="funnel-editable" style="text-align: left;"
                                           value="${ch.funnel[i].label}"
                                           onchange="updateFunnel('${ch.id}', ${i}, 'label', this.value)">
                                </div>
                                <div class="funnel-bar-container">
                                    <div class="funnel-bar" style="width: ${(step.calcValue / maxVal) * 100}%"></div>
                                </div>
                                <div class="funnel-step-value">
                                    ${i === 0 ? `
                                        <input type="number" class="funnel-editable" style="text-align: right;"
                                               value="${ch.funnel[i].value}"
                                               onchange="updateFunnel('${ch.id}', ${i}, 'value', this.value)">
                                    ` : fmt(step.calcValue)}
                                </div>
                                <div class="funnel-step-rate">
                                    ${step.rate !== null ? `
                                        <input type="number" class="funnel-editable" style="text-align: right; color: var(--warning);"
                                               value="${ch.funnel[i].rate}"
                                               step="0.1"
                                               onchange="updateFunnel('${ch.id}', ${i}, 'rate', this.value)">%
                                    ` : '-'}
                                </div>
                                <div>
                                    ${i > 0 ? `<button class="delete-btn" style="opacity: 0.6;" onclick="deleteFunnelStep('${ch.id}', ${i})">&times;</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-sm" style="margin-top: 12px;" onclick="addFunnelStep('${ch.id}')">+ Add Step</button>
                </div>

                ${renderChannelTimelineHTML(ch, calc)}

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Description</span>
                    </div>
                    <input type="text" class="form-input"
                           value="${ch.description}"
                           onchange="updateChannelField('${ch.id}', 'description', this.value)">
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Channel Notes</span>
                    </div>
                    <div class="notes-list" id="channel-notes"></div>
                    <div class="note-input-row">
                        <input type="text" class="note-input" id="channel-note-input" placeholder="Add a note...">
                        <button class="btn btn-primary btn-sm" onclick="addChannelNote('${ch.id}')">Add</button>
                    </div>
                </div>

                <div style="margin-top: 16px; text-align: right;">
                    <button class="btn btn-danger" onclick="deleteChannel('${ch.id}')">Delete Channel</button>
                </div>
            `;

            document.getElementById('channel-content').innerHTML = html;
            renderChannelNotes(ch);
        }

        function renderChannelNotes(ch) {
            const container = document.getElementById('channel-notes');
            if (!container) return;

            if (!ch.notes || ch.notes.length === 0) {
                container.innerHTML = '<div class="empty-state">No notes yet</div>';
            } else {
                container.innerHTML = ch.notes.map((note, i) => {
                    // Handle both string notes and object notes
                    const isObject = typeof note === 'object' && note !== null;
                    const noteDate = isObject ? (note.date || '') : '';
                    const noteText = isObject ? (note.text || '') : note;
                    return `
                        <div class="note-item">
                            ${noteDate ? `
                                <div class="note-item-header">
                                    <span>${noteDate}</span>
                                    <button class="delete-btn" style="opacity: 1;" onclick="deleteChannelNote('${ch.id}', ${i})">&times;</button>
                                </div>
                            ` : `
                                <div class="note-item-header" style="justify-content: flex-end;">
                                    <button class="delete-btn" style="opacity: 1;" onclick="deleteChannelNote('${ch.id}', ${i})">&times;</button>
                                </div>
                            `}
                            <div class="note-item-content">${noteText}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // =====================================================
        // RENDER - WEEKLY
        // =====================================================
        // =====================================================
        // RENDER - ACTIVATIONS TIMELINE
        // =====================================================
        function renderActivations() {
            // Use phases from data model (editable)
            const phases = data.phases || [];

            // Calculate totals per phase
            function getPhaseTotal(channelIds) {
                return channelIds.reduce((sum, id) => {
                    const ch = data.channels.find(c => c.id === id);
                    return sum + (ch ? calcChannel(ch).activations : 0);
                }, 0);
            }

            // Build timeline HTML
            let html = `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Starting Point
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Starting Point</strong>
                                    Your current active user count before growth campaigns begin.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value">${fmt(data.meta.current)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                üéØ Target
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Target Users</strong>
                                    Your goal for total active users by the deadline.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value">${fmt(data.meta.target)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Total Model Output
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Model Output</strong>
                                    Sum of activated users from all channels across all phases.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value success">${fmt(calcTotals())}</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="openPlatformsModal()">
                        <div class="stat-label">
                            <div class="tooltip-wrapper">
                                Platforms
                                <span class="tooltip-icon">?</span>
                                <div class="tooltip-content">
                                    <strong>Platforms</strong>
                                    Target platforms for your growth channels (app, telegram, both). Click to manage.
                                </div>
                            </div>
                        </div>
                        <div class="stat-value" style="font-size: 14px;">${(data.platforms || []).join(', ')}</div>
                        <div style="font-size: 10px; color: var(--accent);">Click to manage</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header">
                        <h3 style="font-size: 14px; margin: 0;">üìÖ Campaign Timeline</h3>
                    </div>
                    ${phases.length === 0 ? `
                        <div class="empty-state">
                            <p>No phases defined yet.</p>
                            <button class="btn btn-primary btn-sm" onclick="openAddPhaseModal()" style="margin-top: 8px;">+ Add your first phase</button>
                        </div>
                    ` : `
                    <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px;">
                        ${phases.map(phase => `
                            <div style="flex: 1; min-width: 200px; background: var(--bg-secondary); border-radius: 8px; padding: 12px; border-left: 3px solid ${phase.color}; position: relative;">
                                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                                    <button class="btn btn-sm" onclick="openEditPhaseModal('${phase.id}')" style="padding: 2px 6px; font-size: 10px;">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePhase('${phase.id}')" style="padding: 2px 6px; font-size: 10px;">&times;</button>
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">${phase.dates || ''}</div>
                                <div style="font-size: 14px; font-weight: 600; margin: 4px 0;">${phase.emoji || ''} ${phase.name}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">${phase.description || ''}</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${phase.color};">
                                    ${phase.channels && phase.channels.length > 0 ? '+' + fmt(getPhaseTotal(phase.channels)) : '‚Äî'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    `}
                </div>
            `;

            // Build detailed breakdown per phase
            phases.forEach(phase => {
                if (!phase.channels || phase.channels.length === 0) return;

                const phaseChannels = phase.channels.map(id => data.channels.find(c => c.id === id)).filter(Boolean);
                const phaseTotal = getPhaseTotal(phase.channels);

                html += `
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-header">
                            <span class="card-title">${phase.emoji || ''} ${phase.name} <span style="color: var(--text-muted); font-weight: normal;">(${phase.dates || ''})</span></span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 14px; font-weight: 700; color: ${phase.color};">+${fmt(phaseTotal)} users</span>
                                <button class="btn btn-sm" onclick="openEditPhaseModal('${phase.id}')" style="padding: 2px 8px;">Edit</button>
                            </div>
                        </div>
                        <div style="margin-top: 12px;">
                            ${phaseChannels.map(ch => {
                                const result = calcChannel(ch);
                                const activations = result.activations;
                                const topOfFunnel = ch.funnel[0].value;
                                const conversionRate = ((activations / topOfFunnel) * 100).toFixed(1);
                                const confidenceColor = ch.confidence === 'high' ? 'var(--success)' : ch.confidence === 'medium' ? 'var(--warning)' : 'var(--danger)';

                                return `
                                    <div class="expandable-channel" style="background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; overflow: hidden;">
                                        <div class="channel-header" onclick="toggleChannelExpand('${ch.id}')" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span class="expand-icon" id="expand-icon-${ch.id}" style="font-size: 10px; color: var(--text-muted); transition: transform 0.2s;">‚ñ∂</span>
                                                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${confidenceColor};"></span>
                                                <div>
                                                    <div style="font-size: 13px; font-weight: 600;">${ch.name}</div>
                                                    <div style="font-size: 11px; color: var(--text-muted);">${ch.description}</div>
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 16px; font-weight: 700; color: var(--success);">+${fmt(activations)}</div>
                                                <div style="font-size: 10px; color: var(--text-muted);">${conversionRate}% conv</div>
                                            </div>
                                        </div>
                                        <div class="channel-details" id="channel-details-${ch.id}" style="display: none; padding: 0 12px 12px 12px; border-top: 1px solid var(--border);">
                                            ${ch.details ? `
                                                <div style="padding-top: 12px;">
                                                    <div style="font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">üìã STRATEGY</div>
                                                    <div style="font-size: 12px; color: var(--text-primary); margin-bottom: 12px; line-height: 1.5;">${ch.details.strategy || ''}</div>
                                                </div>
                                                ${ch.details.concept ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">üí° CONCEPT</div>
                                                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">${ch.details.concept.replace(/\\n/g, '<br>')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.why_it_works ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--success); margin-bottom: 6px;">‚ú® WHY IT WORKS</div>
                                                        <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap;">${ch.details.why_it_works.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.example_roast ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--warning); margin-bottom: 6px;">üìÑ EXAMPLE</div>
                                                        <div style="font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; border-left: 3px solid var(--warning);">${ch.details.example_roast.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.budget_split ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--success); margin-bottom: 6px;">üí∞ BUDGET SPLIT</div>
                                                        <div style="font-size: 11px; color: var(--text-secondary); white-space: pre-wrap;">${ch.details.budget_split.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.campaign_angles ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">üéØ CAMPAIGN ANGLES</div>
                                                        <div style="font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace;">${ch.details.campaign_angles.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.visual_concepts ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: #e91e63; margin-bottom: 6px;">üé® VISUAL CONCEPTS</div>
                                                        <div style="font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace;">${ch.details.visual_concepts.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.cta_options ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--warning); margin-bottom: 6px;">üëÜ CTA OPTIONS</div>
                                                        <div style="font-size: 10px; color: var(--text-muted); white-space: pre-wrap;">${ch.details.cta_options.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.target_audiences ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: #9c27b0; margin-bottom: 6px;">üéØ TARGET AUDIENCES</div>
                                                        <div style="font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace;">${ch.details.target_audiences.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.kpis ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--success); margin-bottom: 6px;">üìä KPIs</div>
                                                        <div style="font-size: 11px; color: var(--text-secondary); white-space: pre-wrap;">${ch.details.kpis.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.breakdown ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: #9b59b6; margin-bottom: 8px;">üî¢ PRE-FUNNEL BREAKDOWN</div>
                                                        <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                                                            ${ch.details.breakdown.map((step, i) => `
                                                                <div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border-radius: 6px; padding: 8px 12px; display: flex; flex-direction: column; align-items: center;">
                                                                    <div style="font-size: 10px; color: rgba(255,255,255,0.8); margin-bottom: 2px;">${step.label}</div>
                                                                    <div style="font-size: 14px; font-weight: 700; color: white;">${typeof step.value === 'number' ? fmt(step.value) : step.value}</div>
                                                                    ${step.rate ? `<div style="font-size: 9px; color: rgba(255,255,255,0.7);">${step.rate}</div>` : ''}
                                                                    ${step.note ? `<div style="font-size: 9px; color: rgba(255,255,255,0.7);">${step.note}</div>` : ''}
                                                                </div>
                                                                ${i < ch.details.breakdown.length - 1 ? '<span style="color: var(--text-muted); font-size: 16px;">‚Üí</span>' : ''}
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.timing ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--warning); margin-bottom: 4px;">‚è∞ TIMING</div>
                                                        <div style="font-size: 12px; color: var(--text-secondary);">${ch.details.timing}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.team ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 4px;">üë• TEAM</div>
                                                        <div style="font-size: 11px; color: var(--text-secondary);">${ch.details.team.join(' ‚Ä¢ ')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.checklist ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--success); margin-bottom: 6px;">‚úÖ CHECKLIST</div>
                                                        ${ch.details.checklist.map(item => `
                                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 3px; padding-left: 12px;">‚òê ${item}</div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                                ${ch.details.template ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px;">üìù TEMPLATE</div>
                                                        <div style="font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 8px; border-radius: 4px; white-space: pre-wrap; font-family: monospace;">${ch.details.template.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                                ${ch.details.rules ? `
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px;">üìú RULES</div>
                                                        <div style="font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 8px; border-radius: 4px; white-space: pre-wrap; font-family: monospace;">${ch.details.rules.replace(/\\n/g, '\n')}</div>
                                                    </div>
                                                ` : ''}
                                            ` : ''}
                                            <div style="padding-top: 12px;">
                                                <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">üìä FUNNEL BREAKDOWN</div>
                                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                                    ${result.steps.map((step, i) => `
                                                        <div style="background: var(--bg-card); border-radius: 4px; padding: 6px 10px; font-size: 11px;">
                                                            <span style="color: var(--text-muted);">${step.label}:</span>
                                                            <span style="font-weight: 600;">${fmt(step.calcValue)}</span>
                                                            ${step.rate ? `<span style="color: var(--warning);">(${step.rate}%)</span>` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            ${ch.notes && ch.notes.length > 0 ? `
                                                <div style="margin-top: 12px;">
                                                    <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px;">üìå NOTES</div>
                                                    ${ch.notes.map(note => {
                                                        const noteText = typeof note === 'object' ? (note.text || '') : note;
                                                        return `<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; padding-left: 8px; border-left: 2px solid var(--border);">${noteText}</div>`;
                                                    }).join('')}
                                                </div>
                                            ` : ''}
                                            <div style="margin-top: 12px;">
                                                <button class="btn btn-sm" onclick="event.stopPropagation(); showPage('channel', '${ch.id}')">Edit Channel ‚Üí</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            // Cumulative projection
            let cumulative = data.meta.current;
            html += `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìä Cumulative User Growth</span>
                    </div>
                    <table class="matrix-table" style="margin-top: 12px;">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Dates</th>
                                <th>New Users</th>
                                <th>Cumulative</th>
                                <th>vs Target</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.weekly.map((week, i) => {
                                cumulative += week.target;
                                const diff = cumulative - data.meta.target;
                                const isMilestone = week.milestone || false;
                                return `
                                    <tr style="${isMilestone ? 'background: var(--bg-secondary); font-weight: 600;' : ''}">
                                        <td style="text-align: left;">${week.name}</td>
                                        <td style="text-align: left; color: var(--text-muted);">${week.dates}</td>
                                        <td style="color: var(--success);">+${fmt(week.target)}</td>
                                        <td style="font-weight: 600;">${fmt(cumulative)}</td>
                                        <td style="color: ${diff >= 0 ? 'var(--success)' : 'var(--warning)'};">
                                            ${diff >= 0 ? '+' : ''}${fmt(diff)}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('activations-content').innerHTML = html;
        }

        // =====================================================
        // RENDER - WEEK MATRIX (REFORGE STYLE)
        // =====================================================
        function renderWeekMatrix() {
            const weeks = data.weekly || [];
            const channels = data.channels;

            // Build header row with weeks
            let headerHtml = '<tr><th>Metric</th>';
            weeks.forEach(week => {
                headerHtml += `<th>${week.name}<br><span style="font-size: 9px; font-weight: 400;">${week.dates}</span></th>`;
            });
            headerHtml += '<th>TOTAL</th></tr>';

            let bodyHtml = '';
            let weeklyImpressions = weeks.map(() => 0);
            let weeklyActivated = weeks.map(() => 0);
            let totalImpressions = 0;
            let totalActivated = 0;

            // For each channel, show breakdown ‚Üí impressions
            channels.forEach(ch => {
                const calc = calcChannel(ch);
                const multipliers = data.projection?.channelMultipliers?.[ch.id] || [];
                const impressions = calc.steps[0]?.calcValue || 0; // First step is impressions
                const activated = calc.activations;

                // Channel header row (dark)
                bodyHtml += `<tr class="channel-header-row">
                    <td colspan="${weeks.length + 2}" style="text-transform: uppercase; letter-spacing: 0.5px;">
                        ${ch.name}
                    </td>
                </tr>`;

                // Show breakdown steps (source numbers) if available
                const breakdown = ch.details?.breakdown || [];
                breakdown.forEach((step, i) => {
                    const isLast = i === breakdown.length - 1;
                    bodyHtml += `<tr class="metric-row">`;
                    bodyHtml += `<td style="padding-left: 20px; color: ${isLast ? 'var(--accent)' : 'var(--text-secondary)'};">${step.label}</td>`;

                    // For breakdown steps, show same value across active weeks (it's a constant)
                    weeks.forEach((week, weekIndex) => {
                        const mult = multipliers[weekIndex] || 0;
                        if (mult > 0) {
                            const displayVal = typeof step.value === 'number' ? fmt(step.value) : step.value;
                            bodyHtml += `<td class="value-cell" style="color: var(--text-muted);">${displayVal}</td>`;
                        } else {
                            bodyHtml += `<td class="value-cell">-</td>`;
                        }
                    });

                    // Total column
                    const displayVal = typeof step.value === 'number' ? fmt(step.value) : step.value;
                    bodyHtml += `<td class="value-cell" style="font-weight: 500;">${displayVal}</td>`;
                    bodyHtml += '</tr>';

                    // Show rate if present
                    if (step.rate) {
                        bodyHtml += `<tr class="metric-row">`;
                        bodyHtml += `<td style="padding-left: 30px; font-size: 10px; color: var(--text-muted);">‚Ü≥ Rate</td>`;
                        weeks.forEach((week, weekIndex) => {
                            const mult = multipliers[weekIndex] || 0;
                            bodyHtml += `<td class="rate-cell">${mult > 0 ? step.rate : '-'}</td>`;
                        });
                        bodyHtml += `<td class="rate-cell">${step.rate}</td>`;
                        bodyHtml += '</tr>';
                    }
                });

                // If no breakdown, show impressions row directly
                if (breakdown.length === 0) {
                    bodyHtml += `<tr class="metric-row">`;
                    bodyHtml += `<td style="padding-left: 20px; color: var(--accent);">Impressions</td>`;

                    weeks.forEach((week, weekIndex) => {
                        const mult = multipliers[weekIndex] || 0;
                        const weekValue = Math.round(impressions * mult);
                        bodyHtml += `<td class="value-cell">${mult > 0 ? fmt(weekValue) : '-'}</td>`;
                        weeklyImpressions[weekIndex] += weekValue;
                    });

                    bodyHtml += `<td class="value-cell" style="font-weight: 600;">${fmt(impressions)}</td>`;
                    bodyHtml += '</tr>';
                } else {
                    // Track impressions from the last breakdown step (which is impressions)
                    weeks.forEach((week, weekIndex) => {
                        const mult = multipliers[weekIndex] || 0;
                        weeklyImpressions[weekIndex] += Math.round(impressions * mult);
                    });
                }

                // Show activated row for this channel
                bodyHtml += `<tr class="metric-row activated-row">`;
                bodyHtml += `<td style="padding-left: 20px;">‚Üí Activated</td>`;

                weeks.forEach((week, weekIndex) => {
                    const mult = multipliers[weekIndex] || 0;
                    const weekValue = Math.round(activated * mult);
                    bodyHtml += `<td class="value-cell">${mult > 0 ? fmt(weekValue) : '-'}</td>`;
                    weeklyActivated[weekIndex] += weekValue;
                });

                bodyHtml += `<td class="value-cell" style="font-weight: 600;">${fmt(activated)}</td>`;
                bodyHtml += '</tr>';

                // Add spacing row between channels
                bodyHtml += `<tr><td colspan="${weeks.length + 2}" style="height: 8px; background: var(--bg-primary); border: none;"></td></tr>`;

                totalImpressions += impressions;
                totalActivated += activated;
            });

            // Total impressions row
            bodyHtml += `<tr class="total-row">
                <td><strong>TOTAL IMPRESSIONS</strong></td>`;
            weeklyImpressions.forEach(total => {
                bodyHtml += `<td style="color: var(--accent); font-size: 12px;">${fmt(total)}</td>`;
            });
            bodyHtml += `<td style="color: var(--accent); font-size: 13px;">${fmt(totalImpressions)}</td>`;
            bodyHtml += '</tr>';

            // Total activated row
            bodyHtml += `<tr class="total-row">
                <td><strong>TOTAL ACTIVATED</strong></td>`;
            weeklyActivated.forEach(total => {
                bodyHtml += `<td style="color: var(--success); font-size: 13px;">${fmt(total)}</td>`;
            });
            bodyHtml += `<td style="color: var(--success); font-size: 14px;">${fmt(totalActivated)}</td>`;
            bodyHtml += '</tr>';

            // Cumulative row
            let cumulative = data.meta.current;
            bodyHtml += `<tr class="total-row">
                <td><strong>CUMULATIVE USERS</strong></td>`;
            weeklyActivated.forEach(total => {
                cumulative += total;
                bodyHtml += `<td style="font-size: 13px;">${fmt(cumulative)}</td>`;
            });
            bodyHtml += `<td style="font-size: 14px; color: var(--warning);">${fmt(cumulative)}</td>`;
            bodyHtml += '</tr>';

            document.getElementById('week-matrix-head').innerHTML = headerHtml;
            document.getElementById('week-matrix-body').innerHTML = bodyHtml;
        }

        function renderWeekly() {
            let cumulative = data.meta.current;

            document.getElementById('weekly-grid').innerHTML = data.weekly.map(week => {
                cumulative += week.target;
                return `
                    <div class="weekly-card ${week.current ? 'current' : ''}">
                        <div class="weekly-card-header">
                            <div class="weekly-card-title">${week.name}</div>
                            <div class="weekly-card-dates">${week.dates}</div>
                        </div>
                        <div class="weekly-metrics">
                            <div class="weekly-metric">
                                <div class="weekly-metric-value">
                                    <input type="number" class="weekly-editable"
                                           value="${week.target}"
                                           onchange="updateWeekly('${week.id}', 'target', this.value)">
                                </div>
                                <div class="weekly-metric-label">Target</div>
                            </div>
                            <div class="weekly-metric">
                                <div class="weekly-metric-value">
                                    <input type="number" class="weekly-editable"
                                           value="${week.actual || ''}"
                                           placeholder="-"
                                           onchange="updateWeekly('${week.id}', 'actual', this.value)">
                                </div>
                                <div class="weekly-metric-label">Actual</div>
                            </div>
                            <div class="weekly-metric" style="grid-column: span 2;">
                                <div class="weekly-metric-value">${fmt(cumulative)}</div>
                                <div class="weekly-metric-label">Cumulative</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =====================================================
        // RENDER - TIME PROJECTION
        // =====================================================
        function renderProjection() {
            // Safety check - ensure projection data exists
            if (!data.projection || !data.projection.weeks || !data.projection.settings || !data.projection.channelMultipliers) {
                console.error('Projection data missing, reinitializing...');
                initializeProjectionData();
                save();
            }

            // Ensure all channels have multipliers
            data.channels.forEach(ch => {
                if (!data.projection.channelMultipliers[ch.id]) {
                    data.projection.channelMultipliers[ch.id] = data.projection.weeks.map(() => 0.1);
                }
                // Ensure multiplier array matches weeks length
                while (data.projection.channelMultipliers[ch.id].length < data.projection.weeks.length) {
                    data.projection.channelMultipliers[ch.id].push(0.1);
                }
            });

            // Sync settings inputs with data
            document.getElementById('proj-start-users').value = data.projection.settings.startUsers;
            document.getElementById('proj-organic-rate').value = data.projection.settings.organicRate;
            document.getElementById('proj-churn-rate').value = data.projection.settings.churnRate;
            document.getElementById('proj-k-factor').value = data.projection.settings.kFactor;

            // Calculate projections
            const projData = calculateProjection();

            // Get unique months for header grouping
            const months = [...new Set(data.projection.weeks.map(w => w.month))];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Month colors for visual grouping
            const monthColors = [
                'rgba(99, 102, 241, 0.08)',
                'rgba(34, 197, 94, 0.08)',
                'rgba(99, 102, 241, 0.08)',
                'rgba(34, 197, 94, 0.08)',
                'rgba(99, 102, 241, 0.08)',
                'rgba(34, 197, 94, 0.08)',
            ];
            const weekMonthColorMap = data.projection.weeks.map(w => {
                const monthIdx = months.indexOf(w.month);
                return monthColors[monthIdx % monthColors.length];
            });

            // Render table header with month groupings
            let headerHtml = '<tr><th rowspan="2">Channel</th><th rowspan="2">Total</th>';
            months.forEach((month, idx) => {
                const weeksInMonth = data.projection.weeks.filter(w => w.month === month).length;
                const bgColor = monthColors[idx % monthColors.length];
                const monthLabel = monthNames[month] || `M${month}`;
                headerHtml += `<th colspan="${weeksInMonth}" style="text-align: center; background: ${bgColor}; border-bottom: 2px solid var(--accent);">${monthLabel}</th>`;
            });
            headerHtml += '</tr><tr>';
            data.projection.weeks.forEach((week, i) => {
                headerHtml += `<th style="background: ${weekMonthColorMap[i]};">${week.name}</th>`;
            });
            headerHtml += '</tr>';
            document.getElementById('projection-head').innerHTML = headerHtml;

            // Render table body - channels as rows
            let bodyHtml = '';

            // Channel rows
            data.channels.forEach(ch => {
                const channelCalc = calcChannel(ch);
                const maxActivations = channelCalc.activations;
                const multipliers = data.projection.channelMultipliers[ch.id] || [];
                const weeklyActivations = multipliers.map(m => Math.round(maxActivations * m));
                const totalForChannel = weeklyActivations.reduce((a, b) => a + b, 0);

                bodyHtml += `<tr onclick="showPage('channel-projection', '${ch.id}')" style="cursor: pointer;">`;
                bodyHtml += `
                    <td>
                        <div class="channel-cell">
                            <span class="confidence-dot confidence-${ch.confidence}"></span>
                            <span class="channel-cell-name">${ch.name}</span>
                        </div>
                    </td>
                    <td style="font-weight: 600; color: var(--success);">${fmt(totalForChannel)}</td>
                `;

                weeklyActivations.forEach((act, i) => {
                    const mult = multipliers[i] || 0;
                    const opacity = Math.min(1, mult + 0.2);
                    bodyHtml += `<td style="opacity: ${opacity}; background: ${weekMonthColorMap[i]};">${fmt(act)}</td>`;
                });

                bodyHtml += '</tr>';
            });

            // Separator
            bodyHtml += '<tr style="height: 8px; background: var(--bg-primary);"><td colspan="100"></td></tr>';

            // Summary rows
            const summaryRows = [
                { label: 'Channel Total', key: 'channelTotal', color: 'var(--text-primary)', bold: true },
                { label: 'Organic Growth', key: 'organicGrowth', color: 'var(--success)' },
                { label: 'Viral Referrals', key: 'viralUsers', color: 'var(--accent)' },
                { label: 'Churned', key: 'churned', color: 'var(--danger)', prefix: '-' },
                { label: 'Net New Users', key: 'newUsers', color: 'var(--text-primary)', bold: true },
                { label: 'Active Users', key: 'activeUsers', color: 'var(--success)', bold: true, final: true }
            ];

            summaryRows.forEach(row => {
                const total = projData.reduce((sum, w) => sum + (w[row.key] || 0), 0);
                bodyHtml += `<tr style="${row.final ? 'background: var(--bg-secondary);' : ''}">`;
                bodyHtml += `<td style="font-weight: ${row.bold ? '600' : '400'}; color: ${row.color};">${row.label}</td>`;
                bodyHtml += `<td style="font-weight: 600; color: ${row.color};">${row.key === 'activeUsers' ? fmt(projData[projData.length - 1]?.activeUsers || 0) : (row.prefix || '') + fmt(Math.abs(total))}</td>`;

                projData.forEach((week, i) => {
                    const val = week[row.key] || 0;
                    const displayVal = row.prefix ? row.prefix + fmt(Math.abs(val)) : fmt(val);
                    bodyHtml += `<td style="color: ${row.color}; font-weight: ${row.bold ? '600' : '400'}; background: ${weekMonthColorMap[i]}; ${row.final ? '' : ''}">${displayVal}</td>`;
                });

                bodyHtml += '</tr>';
            });

            document.getElementById('projection-body').innerHTML = bodyHtml;

            // Render chart
            renderProjectionChart(projData);
        }

        function initializeProjectionData() {
            data.projection = {
                settings: { startUsers: 1500, organicRate: 1.25, churnRate: 0.75, kFactor: 0.04 },
                weeks: [
                    { id: 'w0', name: 'W1', month: 0 },
                    { id: 'w1', name: 'W2', month: 0 },
                    { id: 'w2', name: 'W3', month: 1 },
                    { id: 'w3', name: 'W4', month: 1 }
                ],
                channelMultipliers: {}
            };
            data.channels.forEach(ch => {
                data.projection.channelMultipliers[ch.id] = [0.3, 0.3, 0.2, 0.1];
            });
        }

        function calculateProjection() {
            const settings = data.projection.settings;
            const result = [];

            let prevActive = settings.startUsers;

            data.projection.weeks.forEach((week, i) => {
                const calc = { ...week };

                // Sum channel activations for this week
                let channelTotal = 0;
                data.channels.forEach(ch => {
                    const channelMax = calcChannel(ch).activations;
                    const mult = (data.projection.channelMultipliers[ch.id] || [])[i] || 0;
                    channelTotal += Math.round(channelMax * mult);
                });
                calc.channelTotal = channelTotal;

                if (i === 0) {
                    calc.organicGrowth = 0;
                    calc.viralUsers = 0;
                    calc.churned = 0;
                    calc.newUsers = calc.channelTotal;
                    calc.activeUsers = settings.startUsers + calc.channelTotal;
                } else {
                    calc.organicGrowth = Math.round(prevActive * (settings.organicRate / 100));
                    calc.viralUsers = Math.round(prevActive * settings.kFactor);
                    calc.churned = Math.round(prevActive * (settings.churnRate / 100));
                    calc.newUsers = calc.channelTotal + calc.organicGrowth + calc.viralUsers - calc.churned;
                    calc.activeUsers = prevActive + calc.newUsers;
                }

                prevActive = calc.activeUsers;
                result.push(calc);
            });

            return result;
        }

        function renderProjectionChart(projData) {
            const container = document.getElementById('projection-chart');
            const maxVal = Math.max(...projData.map(w => w.activeUsers), data.meta.target);

            let prevMonth = -1;
            container.innerHTML = projData.map((week, i) => {
                const height = (week.activeUsers / maxVal) * 160;
                const isTarget = week.activeUsers >= data.meta.target;
                const isNewMonth = week.month !== prevMonth;
                prevMonth = week.month;

                return `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; ${isNewMonth && i > 0 ? 'border-left: 1px dashed var(--border); padding-left: 4px;' : ''}">
                        <div style="font-size: 10px; font-weight: 600; color: ${isTarget ? 'var(--success)' : 'var(--text-primary)'};">${fmt(week.activeUsers)}</div>
                        <div style="width: 100%; max-width: 40px; height: ${height}px; background: ${isTarget ? 'var(--success)' : 'var(--accent)'}; border-radius: 4px 4px 0 0; transition: height 0.3s;"></div>
                        <div style="font-size: 9px; color: var(--text-muted);">${week.name}</div>
                    </div>
                `;
            }).join('');

            const targetHeight = (data.meta.target / maxVal) * 160;
            container.innerHTML += `
                <div style="position: absolute; left: 0; right: 0; bottom: ${targetHeight + 44}px; border-top: 2px dashed var(--warning); opacity: 0.5;"></div>
                <div style="position: absolute; right: 10px; bottom: ${targetHeight + 48}px; font-size: 9px; color: var(--warning);">Target: ${fmt(data.meta.target)}</div>
            `;
            container.style.position = 'relative';
        }

        // Channel Projection Detail
        function renderChannelProjection(channelId) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;

            const channelCalc = calcChannel(ch);
            const maxActivations = channelCalc.activations;
            const multipliers = data.projection.channelMultipliers[ch.id] || [];

            document.getElementById('channel-proj-title').textContent = ch.name;
            document.getElementById('channel-proj-subtitle').textContent = `Max activations from funnel: ${fmt(maxActivations)}`;

            const months = [...new Set(data.projection.weeks.map(w => w.month))];

            let html = `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Weekly Multipliers</span>
                        <span class="badge badge-draft">Editable</span>
                    </div>
                    <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px;">
                        Set what % of this channel's max activations (${fmt(maxActivations)}) happens each week.
                        <br>Example: 0.5 = 50% of max = ${fmt(Math.round(maxActivations * 0.5))} users
                    </p>
                    <div style="overflow-x: auto;">
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    ${months.map(m => {
                                        const weeksInMonth = data.projection.weeks.filter(w => w.month === m).length;
                                        return `<th colspan="${weeksInMonth}" style="text-align: center; background: var(--bg-hover);">Month ${m}</th>`;
                                    }).join('')}
                                </tr>
                                <tr>
                                    <th>Metric</th>
                                    ${data.projection.weeks.map(w => `<th>${w.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Multiplier</td>
                                    ${data.projection.weeks.map((w, i) => `
                                        <td>
                                            <input type="number" class="matrix-editable rate"
                                                   value="${multipliers[i] || 0}"
                                                   step="0.05" min="0" max="1"
                                                   style="width: 55px;"
                                                   onchange="updateChannelMultiplier('${ch.id}', ${i}, this.value)">
                                        </td>
                                    `).join('')}
                                </tr>
                                <tr>
                                    <td style="font-weight: 600;">Activations</td>
                                    ${data.projection.weeks.map((w, i) => {
                                        const act = Math.round(maxActivations * (multipliers[i] || 0));
                                        return `<td style="font-weight: 600; color: var(--success);">${fmt(act)}</td>`;
                                    }).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Quick Presets</span>
                    </div>
                    <div class="btn-group" style="flex-wrap: wrap;">
                        <button class="btn btn-sm" onclick="applyPreset('${ch.id}', 'launch')">Launch Spike</button>
                        <button class="btn btn-sm" onclick="applyPreset('${ch.id}', 'steady')">Steady State</button>
                        <button class="btn btn-sm" onclick="applyPreset('${ch.id}', 'ramp')">Slow Ramp</button>
                        <button class="btn btn-sm" onclick="applyPreset('${ch.id}', 'oneshot')">One-Shot</button>
                        <button class="btn btn-sm" onclick="applyPreset('${ch.id}', 'zero')">Zero All</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Channel Summary</span>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Max (from funnel)</div>
                            <div class="stat-value">${fmt(maxActivations)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Projected</div>
                            <div class="stat-value success">${fmt(multipliers.reduce((sum, m, i) => sum + Math.round(maxActivations * m), 0))}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Multiplier</div>
                            <div class="stat-value">${(multipliers.reduce((a, b) => a + b, 0) / multipliers.length).toFixed(2)}√ó</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('channel-proj-content').innerHTML = html;
        }

        function updateChannelMultiplier(channelId, weekIndex, value) {
            if (!data.projection.channelMultipliers[channelId]) {
                data.projection.channelMultipliers[channelId] = data.projection.weeks.map(() => 0);
            }
            data.projection.channelMultipliers[channelId][weekIndex] = parseFloat(value) || 0;
            save();
            renderChannelProjection(channelId);
        }

        function applyPreset(channelId, preset) {
            const numWeeks = data.projection.weeks.length;
            let multipliers = [];

            switch (preset) {
                case 'launch':
                    multipliers = [0.7, 0.5, 0.2, 0.1, ...Array(numWeeks - 4).fill(0.05)];
                    break;
                case 'steady':
                    multipliers = Array(numWeeks).fill(0.3);
                    break;
                case 'ramp':
                    multipliers = Array(numWeeks).fill(0).map((_, i) => Math.min(0.5, 0.1 + i * 0.05));
                    break;
                case 'oneshot':
                    multipliers = [1, ...Array(numWeeks - 1).fill(0)];
                    break;
                case 'zero':
                    multipliers = Array(numWeeks).fill(0);
                    break;
            }

            data.projection.channelMultipliers[channelId] = multipliers.slice(0, numWeeks);
            save();
            if (currentChannel === channelId) renderChannel(channelId);
            renderChannelProjection(channelId);
        }

        function updateProjectionSettings() {
            data.projection.settings.startUsers = parseInt(document.getElementById('proj-start-users').value) || 0;
            data.projection.settings.organicRate = parseFloat(document.getElementById('proj-organic-rate').value) || 0;
            data.projection.settings.churnRate = parseFloat(document.getElementById('proj-churn-rate').value) || 0;
            data.projection.settings.kFactor = parseFloat(document.getElementById('proj-k-factor').value) || 0;
            save();
            renderProjection();
        }

        function addProjectionWeek() {
            const weekNum = data.projection.weeks.length;

            // Calculate month based on existing weeks pattern
            // Look at the last week's month and count how many weeks are in that month
            let newMonth;
            if (weekNum === 0) {
                newMonth = 0;
            } else {
                const lastWeek = data.projection.weeks[weekNum - 1];
                const lastMonth = lastWeek.month;
                const weeksInLastMonth = data.projection.weeks.filter(w => w.month === lastMonth).length;

                // Start a new month if current month already has 4 weeks
                // (or 5 for months that have 5 weeks in reality, but 4 is a good default)
                newMonth = weeksInLastMonth >= 4 ? lastMonth + 1 : lastMonth;
            }

            data.projection.weeks.push({
                id: 'w' + weekNum,
                name: 'W' + (weekNum + 1),
                month: newMonth
            });
            // Extend all channel multipliers
            Object.keys(data.projection.channelMultipliers).forEach(chId => {
                data.projection.channelMultipliers[chId].push(0.1);
            });
            save();
            renderProjection();
        }

        function removeProjectionWeek() {
            if (data.projection.weeks.length <= 1) {
                showAlert('Must have at least one week');
                return;
            }
            data.projection.weeks.pop();
            // Trim all channel multipliers
            Object.keys(data.projection.channelMultipliers).forEach(chId => {
                data.projection.channelMultipliers[chId].pop();
            });
            save();
            renderProjection();
        }

        // =====================================================
        // SNAPSHOT & PLANNED VS ACTUAL
        // =====================================================

        function initializeSnapshotData() {
            if (!data.snapshots) data.snapshots = [];
            if (!data.actuals) data.actuals = [];
        }

        function initializeActuals() {
            initializeSnapshotData();
            const weeks = data.projection.weeks;
            // Ensure actuals array matches projection weeks
            while (data.actuals.length < weeks.length) {
                data.actuals.push({ week: weeks[data.actuals.length].name, activeUsers: null });
            }
            // Update week names in actuals to match current projection
            weeks.forEach((w, i) => {
                if (data.actuals[i]) data.actuals[i].week = w.name;
            });
        }

        function takeSnapshot() {
            initializeSnapshotData();
            const projData = calculateProjection();
            const now = new Date();
            const label = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' plan';

            const snapshot = {
                id: 'snap_' + Date.now(),
                date: now.toISOString(),
                label: label,
                visible: true,
                projection: projData.map((w, i) => ({
                    week: data.projection.weeks[i].name,
                    activeUsers: w.activeUsers
                }))
            };

            data.snapshots.push(snapshot);
            save();
            showToast('Snapshot saved', 'success');
        }

        function deleteSnapshot(snapId) {
            initializeSnapshotData();
            data.snapshots = data.snapshots.filter(s => s.id !== snapId);
            save();
            renderSnapshots();
        }

        function toggleSnapshotVisibility(snapId) {
            initializeSnapshotData();
            const snap = data.snapshots.find(s => s.id === snapId);
            if (snap) {
                snap.visible = !snap.visible;
                save();
                renderSnapshots();
            }
        }

        function updateSnapshotLabel(snapId, newLabel) {
            initializeSnapshotData();
            const snap = data.snapshots.find(s => s.id === snapId);
            if (snap) {
                snap.label = newLabel;
                save();
            }
        }

        function updateActual(weekIndex, value) {
            initializeActuals();
            const parsed = value === '' ? null : parseInt(value);
            data.actuals[weekIndex].activeUsers = parsed;
            save();
            renderSnapshots();
        }

        function renderSnapshots() {
            initializeSnapshotData();
            initializeActuals();

            const weeks = data.projection.weeks;
            const latestSnap = data.snapshots.length > 0 ? data.snapshots[data.snapshots.length - 1] : null;

            // ---- Actuals table ----
            let headHtml = '<tr><th>Week</th>';
            if (latestSnap) headHtml += '<th>Planned</th>';
            headHtml += '<th>Actual</th>';
            if (latestSnap) headHtml += '<th>Delta</th>';
            headHtml += '</tr>';
            document.getElementById('actuals-head').innerHTML = headHtml;

            let bodyHtml = '';
            weeks.forEach((w, i) => {
                const actual = data.actuals[i];
                const actualVal = actual ? actual.activeUsers : null;
                const plannedVal = latestSnap && latestSnap.projection[i] ? latestSnap.projection[i].activeUsers : null;

                bodyHtml += '<tr>';
                bodyHtml += `<td style="font-weight: 600;">${w.name}</td>`;
                if (latestSnap) {
                    bodyHtml += `<td style="color: var(--text-secondary);">${plannedVal !== null ? fmt(plannedVal) : '-'}</td>`;
                }
                bodyHtml += `<td><input type="number" class="weekly-editable" value="${actualVal !== null ? actualVal : ''}" placeholder="-" style="width: 80px; font-size: 12px;" onchange="updateActual(${i}, this.value)"></td>`;
                if (latestSnap) {
                    let deltaHtml = '-';
                    if (actualVal !== null && plannedVal !== null) {
                        const delta = actualVal - plannedVal;
                        const pct = plannedVal > 0 ? Math.round((delta / plannedVal) * 100) : 0;
                        const color = delta >= 0 ? 'var(--success)' : 'var(--danger)';
                        deltaHtml = `<span style="color: ${color}; font-weight: 600;">${delta >= 0 ? '+' : ''}${fmt(delta)} (${delta >= 0 ? '+' : ''}${pct}%)</span>`;
                    }
                    bodyHtml += `<td>${deltaHtml}</td>`;
                }
                bodyHtml += '</tr>';
            });
            document.getElementById('actuals-body').innerHTML = bodyHtml;

            // ---- Comparison chart (SVG) ----
            renderComparisonChart();

            // ---- Snapshots list ----
            const listEl = document.getElementById('snapshots-list');
            if (data.snapshots.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-muted); font-size: 12px;">No snapshots yet. Go to Time Projection and click "Take Snapshot" to save the current plan.</p>';
            } else {
                const snapshotColors = ['#6366f1', '#f59e0b', '#ec4899', '#14b8a6', '#8b5cf6', '#f97316'];
                listEl.innerHTML = data.snapshots.map((snap, idx) => {
                    const date = new Date(snap.date);
                    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const color = snapshotColors[idx % snapshotColors.length];
                    const isVisible = snap.visible !== false;
                    const finalUsers = snap.projection.length > 0 ? snap.projection[snap.projection.length - 1].activeUsers : 0;

                    return `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${color}; opacity: ${isVisible ? 1 : 0.3}; flex-shrink: 0; cursor: pointer;" onclick="toggleSnapshotVisibility('${snap.id}')" title="Toggle visibility"></div>
                            <div style="flex: 1; min-width: 0;">
                                <input type="text" value="${snap.label}" style="background: transparent; border: none; color: var(--text-primary); font-size: 13px; font-weight: 600; width: 100%; outline: none;" onchange="updateSnapshotLabel('${snap.id}', this.value)">
                                <div style="font-size: 10px; color: var(--text-muted);">${dateStr} at ${timeStr}</div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); white-space: nowrap;">${fmt(finalUsers)} users projected</div>
                            <button onclick="deleteSnapshot('${snap.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; padding: 4px;" title="Delete snapshot">x</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderComparisonChart() {
            const container = document.getElementById('comparison-chart-container');
            const weeks = data.projection.weeks;
            const snapshotColors = ['#6366f1', '#f59e0b', '#ec4899', '#14b8a6', '#8b5cf6', '#f97316'];

            if (data.snapshots.length === 0 && data.actuals.every(a => a.activeUsers === null)) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 40px;">Take a snapshot and enter actual numbers to see the comparison chart.</p>';
                return;
            }

            // Collect all values to determine scale
            let allValues = [];
            data.snapshots.filter(s => s.visible !== false).forEach(snap => {
                snap.projection.forEach(p => allValues.push(p.activeUsers));
            });
            data.actuals.forEach(a => { if (a.activeUsers !== null) allValues.push(a.activeUsers); });

            if (allValues.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 40px;">No data to display yet.</p>';
                return;
            }

            const maxVal = Math.max(...allValues) * 1.1;
            const minVal = 0;

            const svgWidth = 700;
            const svgHeight = 240;
            const padLeft = 55;
            const padRight = 20;
            const padTop = 20;
            const padBottom = 30;
            const plotW = svgWidth - padLeft - padRight;
            const plotH = svgHeight - padTop - padBottom;
            const numWeeks = weeks.length;

            function xPos(i) { return padLeft + (i / Math.max(1, numWeeks - 1)) * plotW; }
            function yPos(val) { return padTop + plotH - ((val - minVal) / (maxVal - minVal)) * plotH; }

            // Build SVG
            let svg = `<svg viewBox="0 0 ${svgWidth} ${svgHeight}" style="width: 100%; height: auto; font-family: -apple-system, BlinkMacSystemFont, sans-serif;">`;

            // Grid lines
            const gridSteps = 5;
            for (let g = 0; g <= gridSteps; g++) {
                const val = minVal + (maxVal - minVal) * (g / gridSteps);
                const y = yPos(val);
                svg += `<line x1="${padLeft}" y1="${y}" x2="${svgWidth - padRight}" y2="${y}" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="4,4"/>`;
                svg += `<text x="${padLeft - 8}" y="${y + 4}" text-anchor="end" fill="var(--text-muted)" font-size="9">${fmt(Math.round(val))}</text>`;
            }

            // X-axis labels
            weeks.forEach((w, i) => {
                const x = xPos(i);
                svg += `<text x="${x}" y="${svgHeight - 6}" text-anchor="middle" fill="var(--text-muted)" font-size="9">${w.name}</text>`;
            });

            // Snapshot lines
            data.snapshots.filter(s => s.visible !== false).forEach((snap, idx) => {
                const color = snapshotColors[idx % snapshotColors.length];
                const points = snap.projection.map((p, i) => `${xPos(i)},${yPos(p.activeUsers)}`).join(' ');
                svg += `<polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" stroke-dasharray="6,3" opacity="0.7"/>`;
                // Dots
                snap.projection.forEach((p, i) => {
                    svg += `<circle cx="${xPos(i)}" cy="${yPos(p.activeUsers)}" r="2.5" fill="${color}" opacity="0.7"/>`;
                });
            });

            // Actuals line (bold, white)
            const actualPoints = [];
            data.actuals.forEach((a, i) => {
                if (a.activeUsers !== null) {
                    actualPoints.push({ i, val: a.activeUsers });
                }
            });
            if (actualPoints.length > 0) {
                const pointsStr = actualPoints.map(p => `${xPos(p.i)},${yPos(p.val)}`).join(' ');
                svg += `<polyline points="${pointsStr}" fill="none" stroke="#22c55e" stroke-width="2.5"/>`;
                actualPoints.forEach(p => {
                    svg += `<circle cx="${xPos(p.i)}" cy="${yPos(p.val)}" r="4" fill="#22c55e"/>`;
                    svg += `<text x="${xPos(p.i)}" y="${yPos(p.val) - 8}" text-anchor="middle" fill="#22c55e" font-size="9" font-weight="600">${fmt(p.val)}</text>`;
                });
            }

            svg += '</svg>';

            // Legend
            let legend = '<div style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 12px; padding: 0 4px;">';
            data.snapshots.filter(s => s.visible !== false).forEach((snap, idx) => {
                const color = snapshotColors[idx % snapshotColors.length];
                legend += `<div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary);"><div style="width: 16px; height: 2px; background: ${color}; border-radius: 1px;"></div>${snap.label}</div>`;
            });
            if (actualPoints.length > 0) {
                legend += '<div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--success); font-weight: 600;"><div style="width: 16px; height: 3px; background: var(--success); border-radius: 1px;"></div>Actual</div>';
            }
            legend += '</div>';

            container.innerHTML = svg + legend;
        }

        // =====================================================
        // NAVIGATION
        // =====================================================
        function showPage(pageId, channelId = null, updateHash = true) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[data-page="${pageId}"]${channelId ? `[data-channel="${channelId}"]` : ''}`);
            if (navItem) navItem.classList.add('active');

            if (pageId === 'matrix') renderMatrix();
            if (pageId === 'weekmatrix') renderWeekMatrix();
            if (pageId === 'activations') renderActivations();
            if (pageId === 'channel' && channelId) renderChannel(channelId);
            if (pageId === 'weekly') renderWeekly();
            if (pageId === 'projection') renderProjection();
            if (pageId === 'snapshots') renderSnapshots();
            if (pageId === 'channel-projection' && channelId) renderChannelProjection(channelId);
            if (pageId === 'docs') {} // Static page, no render needed
            if (pageId === 'financial') renderFinancial();
            if (pageId === 'campaign' && channelId) renderCampaignDetail(channelId);
            if (pageId === 'expense' && channelId) renderExpenseDetail(channelId);
            if (pageId === 'stream' && channelId) renderStreamDetail(channelId);

            // Update URL hash for shareable links
            if (updateHash) {
                const hash = channelId ? `${pageId}/${channelId}` : pageId;
                history.pushState(null, '', '#' + hash);
            }
        }

        function handleHashChange() {
            const hash = window.location.hash.slice(1); // Remove the '#'
            if (!hash) {
                showPage('matrix', null, false);
                return;
            }

            const parts = hash.split('/');
            const pageId = parts[0];
            const channelId = parts[1] || null;

            // Validate the page exists
            const pageEl = document.getElementById('page-' + pageId);
            if (pageEl) {
                showPage(pageId, channelId, false);
            } else {
                showPage('matrix', null, false);
            }
        }

        // =====================================================
        // UPDATES
        // =====================================================
        function updateFunnel(channelId, stepIndex, field, value) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;

            if (field === 'value' || field === 'rate') {
                ch.funnel[stepIndex][field] = parseFloat(value) || 0;
            } else {
                ch.funnel[stepIndex][field] = value;
            }

            save();
            renderSidebar();
            if (currentChannel === channelId) renderChannel(channelId);
            else renderMatrix();
        }

        function updateChannelField(channelId, field, value) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;
            ch[field] = value;
            save();
            renderSidebar();
        }

        function updateMeta(field, value) {
            data.meta[field] = value;
            data.meta.lastUpdated = new Date().toISOString();
            save();
            renderSidebar();
            renderMatrix();
        }

        function updateWeekly(weekId, field, value) {
            const week = data.weekly.find(w => w.id === weekId);
            if (!week) return;
            week[field] = value === '' ? null : parseInt(value);
            save();
            renderWeekly();
        }

        function setConf(channelId, conf) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;
            ch.confidence = conf;
            save();
            renderSidebar();
            renderChannel(channelId);
        }

        function setPlatform(channelId, platform) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;
            ch.platform = platform;
            save();
            renderSidebar();
            renderChannel(channelId);
        }

        function cycleConf(channelId) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;
            const levels = ['low', 'medium', 'high'];
            const i = levels.indexOf(ch.confidence);
            ch.confidence = levels[(i + 1) % 3];
            save();
            renderSidebar();
            renderMatrix();
        }

        function setScenario(mult) {
            data.scenario = mult;
            document.querySelectorAll('.scenario-option').forEach(el => {
                el.classList.toggle('active', parseFloat(el.dataset.mult) === mult);
            });
            save();
            renderSidebar();
            renderMatrix();
        }

        // =====================================================
        // ADD / DELETE
        // =====================================================
        function openAddChannelModal() {
            // Populate platforms dynamically
            const platforms = data.platforms || ['app', 'web', 'both'];
            const platformContainer = document.getElementById('new-channel-platform');
            platformContainer.innerHTML = platforms.map((plat, i) => `
                <button type="button" class="btn btn-sm ${i === platforms.length - 1 ? 'btn-primary' : ''}"
                        data-plat="${plat}" onclick="selectNewPlatform('${plat}')">${plat}</button>
            `).join('');
            newChannelPlatform = platforms[platforms.length - 1];
            document.getElementById('modal-add-channel').classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function selectNewConf(conf) {
            newChannelConf = conf;
            document.querySelectorAll('#new-channel-confidence .confidence-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.conf === conf);
            });
        }

        function selectNewPlatform(plat) {
            newChannelPlatform = plat;
            document.querySelectorAll('#new-channel-platform button').forEach(el => {
                el.classList.toggle('btn-primary', el.dataset.plat === plat);
            });
        }

        function addChannel() {
            const name = document.getElementById('new-channel-name').value.trim();
            const desc = document.getElementById('new-channel-desc').value.trim();

            if (!name) { showAlert('Enter a channel name'); return; }

            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();

            data.channels.push({
                id,
                name,
                description: desc || 'New channel',
                platform: newChannelPlatform,
                confidence: newChannelConf,
                funnel: [
                    { label: 'Top', value: 1000, rate: null },
                    { label: 'Step 1', value: 500, rate: 50 },
                    { label: 'Activated', value: 350, rate: 70 }
                ],
                notes: []
            });

            // Initialize projection multipliers for new channel
            if (data.projection && data.projection.channelMultipliers) {
                data.projection.channelMultipliers[id] = data.projection.weeks.map(() => 0.1);
            }

            save();
            closeModal('modal-add-channel');
            document.getElementById('new-channel-name').value = '';
            document.getElementById('new-channel-desc').value = '';
            selectNewConf('medium');
            selectNewPlatform('both');
            renderSidebar();
            renderMatrix();
        }

        async function deleteChannel(channelId) {
            if (!await showConfirm('Delete this channel?', 'Delete Channel')) return;
            data.channels = data.channels.filter(c => c.id !== channelId);
            // Also remove from phases
            if (data.phases) {
                data.phases.forEach(phase => {
                    phase.channels = phase.channels.filter(id => id !== channelId);
                });
            }
            save();
            showPage('matrix');
            renderSidebar();
        }

        function moveView(viewId, direction) {
            let viewOrder = JSON.parse(localStorage.getItem('growthmodel_viewOrder') || 'null') || ['matrix', 'activations', 'projection', 'snapshots', 'weekmatrix', 'financial'];
            const idx = viewOrder.indexOf(viewId);
            if (idx === -1) return;
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= viewOrder.length) return;
            const temp = viewOrder[idx];
            viewOrder[idx] = viewOrder[newIdx];
            viewOrder[newIdx] = temp;
            localStorage.setItem('growthmodel_viewOrder', JSON.stringify(viewOrder));
            renderSidebar();
        }

        function moveChannel(channelId, direction) {
            const idx = data.channels.findIndex(c => c.id === channelId);
            if (idx === -1) return;

            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= data.channels.length) return;

            // Swap channels
            const temp = data.channels[idx];
            data.channels[idx] = data.channels[newIdx];
            data.channels[newIdx] = temp;

            save();
            renderSidebar();
            renderMatrix();

            // Update active nav item highlight
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.channel === channelId) {
                    item.classList.add('active');
                }
            });
        }

        // =====================================================
        // PHASE MANAGEMENT
        // =====================================================
        function openAddPhaseModal() {
            document.getElementById('modal-phase-title').textContent = 'Add Phase';
            document.getElementById('edit-phase-id').value = '';
            document.getElementById('phase-name').value = '';
            document.getElementById('phase-dates').value = '';
            document.getElementById('phase-description').value = '';
            document.getElementById('phase-emoji').value = 'üìà';
            document.getElementById('phase-color').value = 'var(--accent)';
            renderPhaseChannels([]);
            document.getElementById('modal-phase').classList.add('show');
        }

        function openEditPhaseModal(phaseId) {
            const phase = data.phases.find(p => p.id === phaseId);
            if (!phase) return;
            document.getElementById('modal-phase-title').textContent = 'Edit Phase';
            document.getElementById('edit-phase-id').value = phaseId;
            document.getElementById('phase-name').value = phase.name || '';
            document.getElementById('phase-dates').value = phase.dates || '';
            document.getElementById('phase-description').value = phase.description || '';
            document.getElementById('phase-emoji').value = phase.emoji || '';
            document.getElementById('phase-color').value = phase.color || 'var(--accent)';
            renderPhaseChannels(phase.channels || []);
            document.getElementById('modal-phase').classList.add('show');
        }

        function renderPhaseChannels(selectedChannels) {
            const container = document.getElementById('phase-channels');
            container.innerHTML = data.channels.map(ch => `
                <label style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-secondary); border-radius: 4px; font-size: 11px; cursor: pointer;">
                    <input type="checkbox" value="${ch.id}" ${selectedChannels.includes(ch.id) ? 'checked' : ''}>
                    ${ch.name}
                </label>
            `).join('');
        }

        function savePhase() {
            const id = document.getElementById('edit-phase-id').value;
            const name = document.getElementById('phase-name').value.trim();
            const dates = document.getElementById('phase-dates').value.trim();
            const description = document.getElementById('phase-description').value.trim();
            const emoji = document.getElementById('phase-emoji').value.trim() || 'üìà';
            const color = document.getElementById('phase-color').value;
            const channels = Array.from(document.querySelectorAll('#phase-channels input:checked')).map(cb => cb.value);

            if (!name) { showAlert('Enter a phase name'); return; }

            if (!data.phases) data.phases = [];

            if (id) {
                // Edit existing
                const phase = data.phases.find(p => p.id === id);
                if (phase) {
                    phase.name = name;
                    phase.dates = dates;
                    phase.description = description;
                    phase.emoji = emoji;
                    phase.color = color;
                    phase.channels = channels;
                }
            } else {
                // Add new
                data.phases.push({
                    id: 'phase_' + Date.now(),
                    name,
                    dates,
                    description,
                    emoji,
                    color,
                    channels
                });
            }

            save();
            closeModal('modal-phase');
            renderActivations();
        }

        async function deletePhase(phaseId) {
            if (!await showConfirm('Delete this phase?', 'Delete Phase')) return;
            data.phases = data.phases.filter(p => p.id !== phaseId);
            save();
            renderActivations();
        }

        // =====================================================
        // PLATFORM MANAGEMENT
        // =====================================================
        function openPlatformsModal() {
            renderPlatformsList();
            document.getElementById('modal-platforms').classList.add('show');
        }

        function renderPlatformsList() {
            const platforms = data.platforms || ['app', 'web', 'both'];
            document.getElementById('platforms-list').innerHTML = platforms.map(plat => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 6px;">
                    <span style="font-size: 12px;">${plat}</span>
                    <button class="btn btn-sm btn-danger" onclick="deletePlatform('${plat}')" style="padding: 2px 8px; font-size: 10px;">Delete</button>
                </div>
            `).join('');
        }

        function addPlatform() {
            const input = document.getElementById('new-platform-name');
            const name = input.value.trim().toLowerCase();
            if (!name) return;
            if (!data.platforms) data.platforms = ['app', 'web', 'both'];
            if (data.platforms.includes(name)) {
                showAlert('Platform already exists');
                return;
            }
            data.platforms.push(name);
            save();
            renderPlatformsList();
            renderSidebar();
            renderMatrix();
            // Update channel view if open
            if (currentChannel) renderChannel(currentChannel);
            input.value = '';
        }

        async function deletePlatform(name) {
            if (!await showConfirm(`Delete platform "${name}"? Channels using this platform will be updated.`, 'Delete Platform')) return;
            data.platforms = data.platforms.filter(p => p !== name);
            // Update channels using this platform to first available
            const fallback = data.platforms[0] || 'both';
            data.channels.forEach(ch => {
                if (ch.platform === name) ch.platform = fallback;
            });
            save();
            renderPlatformsList();
            renderMatrix();
            renderSidebar();
        }

        async function addFunnelStep(channelId) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;

            const label = await showPrompt('Step label:', 'New Step', 'Add Funnel Step');
            if (!label) return;

            ch.funnel.push({ label, value: 0, rate: 50 });
            save();
            renderChannel(channelId);
            renderSidebar();
        }

        function deleteFunnelStep(channelId, index) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch || index === 0) return;

            ch.funnel.splice(index, 1);
            save();
            renderChannel(channelId);
            renderSidebar();
        }

        function addGlobalNote() {
            const input = document.getElementById('global-note-input');
            const text = input.value.trim();
            if (!text) return;

            data.notes.unshift({ date: today(), text });
            save();
            renderGlobalNotes();
            input.value = '';
        }

        function deleteGlobalNote(index) {
            data.notes.splice(index, 1);
            save();
            renderGlobalNotes();
        }

        function addChannelNote(channelId) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;

            const input = document.getElementById('channel-note-input');
            const text = input.value.trim();
            if (!text) return;

            ch.notes.unshift({ date: today(), text });
            save();
            renderChannelNotes(ch);
            input.value = '';
        }

        function deleteChannelNote(channelId, index) {
            const ch = data.channels.find(c => c.id === channelId);
            if (!ch) return;

            ch.notes.splice(index, 1);
            save();
            renderChannelNotes(ch);
        }

        // =====================================================
        // STORAGE
        // =====================================================
        let hasUnsavedChanges = false;
        let saveTimeout = null;
        let serverAvailable = true;

        function save() {
            data.meta.lastUpdated = new Date().toISOString();
            hasUnsavedChanges = true;
            updateSaveIndicator();

            // ALWAYS save to localStorage immediately as backup
            try {
                localStorage.setItem('growth-model-data', JSON.stringify(data));
            } catch (e) {
                console.error('localStorage save failed:', e);
            }

            // Debounce: auto-save to server after 500ms of no changes
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => autoSave(), 500);
        }

        async function autoSave() {
            // Always try server first
            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    hasUnsavedChanges = false;
                    serverAvailable = true;
                    updateSaveIndicator();
                    showToast('‚úì Saved to server', 'success');
                } else {
                    throw new Error(result.error || 'Save failed');
                }
            } catch (err) {
                console.error('Server save failed:', err);
                serverAvailable = false;
                hasUnsavedChanges = true; // Keep as unsaved - server didn't get it
                updateSaveIndicator();
                showServerError(err.message);
            }
        }

        let serverErrorShown = false;
        function showServerError(errMsg) {
            // Show toast
            showToast('‚ùå SERVER SAVE FAILED - Data saved locally only', 'error');

            // Show persistent banner if not already shown
            if (!serverErrorShown) {
                serverErrorShown = true;
                const banner = document.createElement('div');
                banner.id = 'server-error-banner';
                banner.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; background: #dc2626; color: white; padding: 12px 20px; z-index: 9999; display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                        <span>‚ö†Ô∏è <strong>Server connection lost!</strong> Changes are being saved locally only. Make sure the server is running: <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px;">node server.js</code></span>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="retryServerConnection()" style="background: white; color: #dc2626; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600;">Retry Connection</button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove(); serverErrorShown = false;" style="background: transparent; color: white; border: 1px solid white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Dismiss</button>
                        </div>
                    </div>
                `;
                document.body.prepend(banner);
            }
        }

        async function retryServerConnection() {
            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        serverAvailable = true;
                        hasUnsavedChanges = false;
                        serverErrorShown = false;
                        document.getElementById('server-error-banner')?.remove();
                        showToast('‚úì Reconnected! Data saved to server', 'success');
                        updateSaveIndicator();
                        return;
                    }
                }
                throw new Error('Still failing');
            } catch (e) {
                showToast('‚ùå Still cannot reach server', 'error');
            }
        }

        function updateSaveIndicator() {
            const indicator = document.getElementById('unsaved-indicator');
            if (indicator) {
                indicator.style.display = hasUnsavedChanges ? 'inline' : 'none';
            }
        }

        async function load() {
            // Try to load from server API first (local server)
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    const loaded = await response.json();
                    if (loaded && loaded.meta) {
                        data = loaded;
                        console.log('Loaded data from server');
                        return;
                    }
                }
            } catch (e) {
                console.log('Could not load from server:', e);
            }

            // Try to load from data.json file directly
            try {
                const response = await fetch('data.json');
                if (response.ok) {
                    const loaded = await response.json();
                    if (loaded && loaded.meta) {
                        data = loaded;
                        console.log('Loaded data from data.json');
                        return;
                    }
                }
            } catch (e) {
                console.log('Could not load from data.json:', e);
            }

            // Fall back to localStorage
            const saved = localStorage.getItem('growth-model-data');
            if (saved) {
                try {
                    data = JSON.parse(saved);
                    console.log('Loaded data from localStorage');
                    return;
                } catch (e) {
                    console.log('Could not parse localStorage:', e);
                }
            }
            // If nothing found, use the embedded defaults (already set)
            console.log('Using embedded defaults');
        }

        function saveChanges() {
            data.meta.lastUpdated = new Date().toISOString();
            const json = JSON.stringify(data, null, 2);
            download(json, 'growth-model-data.json', 'application/json');
            hasUnsavedChanges = false;
            updateSaveIndicator();
            showToast('Saved! Replace growth-model-data.json with the downloaded file.');
        }

        function exportJSON() {
            const json = JSON.stringify(data, null, 2);
            download(json, 'growth-model-data.json', 'application/json');
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        data = JSON.parse(ev.target.result);
                        save();
                        renderSidebar();
                        renderMatrix();
                        showToast('Imported');
                    } catch (err) {
                        showAlert('Invalid JSON file. Please check the format and try again.', 'Import Error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function resetToDefaults() {
            if (!await showConfirm('Reset all data to defaults from growth-model-data.json? Any unsaved changes will be lost.', 'Reset Data')) return;
            localStorage.removeItem('growth-model-data');
            localStorage.removeItem('growth-model-data');
            hasUnsavedChanges = false;
            location.reload();
        }

        function download(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        // =====================================================
        // HELPERS
        // =====================================================
        function fmt(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toLocaleString();
        }

        function today() {
            return new Date().toISOString().split('T')[0];
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            toastMsg.textContent = msg;

            // Reset classes
            toast.classList.remove('show', 'toast-success', 'toast-warning', 'toast-error');

            // Add type class
            if (type === 'success') toast.classList.add('toast-success');
            else if (type === 'warning') toast.classList.add('toast-warning');
            else if (type === 'error') toast.classList.add('toast-error');

            toast.classList.add('show');
            const duration = type === 'warning' || type === 'error' ? 3000 : 1500;
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // =====================================================
        // PROJECT BRANDING
        // =====================================================
        function renderBranding() {
            // Update document title
            if (data.project?.name) {
                document.title = data.project.name;
            }

            // Render sidebar branding
            const container = document.getElementById('sidebar-branding');
            if (!container) return;

            if (data.project?.branding?.url && data.project?.branding?.name) {
                container.innerHTML = `
                    <a href="${data.project.branding.url}" target="_blank"
                       style="font-size: 10px; color: var(--text-muted); text-decoration: none; opacity: 0.7; transition: opacity 0.2s;">
                        Powered by <span style="color: var(--accent);">${data.project.branding.name}</span>
                    </a>
                `;
            } else if (data.project?.name) {
                container.innerHTML = `
                    <span style="font-size: 10px; color: var(--text-muted); opacity: 0.7;">
                        ${data.project.name}
                    </span>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        // =====================================================
        // FINANCIAL MODEL
        // =====================================================
        let currentFinancialScenario = 'base';

        function initFinancialData() {
            if (!data.financial) {
                data.financial = {
                    settings: { currency: 'USD', projectionMonths: 12, scenario: 1 },
                    b2c: {
                        enabled: true,
                        launchDate: 2,
                        pricing: { monthly: 10, annual: 96, annualDiscount: 20 },
                        assumptions: { conversionRate: 3, churnRate: 5, daysToConvert: 14, activeUserPercent: 70 }
                    },
                    b2b: {
                        enabled: true,
                        launchDate: 6,
                        costPerUser: 0.4,
                        assumptions: { addressablePercent: 80 }
                    },
                    scenarios: {
                        conservative: { multiplier: 0.7, b2cConversion: 2, b2bFillRate: 10, b2bCampaigns: 1 },
                        base: { multiplier: 1.0, b2cConversion: 3, b2bFillRate: 15, b2bCampaigns: 2 },
                        optimistic: { multiplier: 1.3, b2cConversion: 5, b2bFillRate: 25, b2bCampaigns: 4 }
                    },
                    campaigns: [],
                    customStreams: [],
                    expenses: []
                };
            }
            // Ensure customStreams array exists for older data
            if (!data.financial.customStreams) {
                data.financial.customStreams = [];
            }
            // Ensure expenses array exists for older data
            if (!data.financial.expenses) {
                data.financial.expenses = [];
            }

            // Fix invalid launchDate values (clamp to 0-47)
            if (data.financial.b2c?.launchDate > 47) {
                data.financial.b2c.launchDate = 2;
            }
            if (data.financial.b2b?.launchDate > 47) {
                data.financial.b2b.launchDate = 6;
            }

            // Migrate legacy b2c/b2b config into custom streams if not already present
            const streams = data.financial.customStreams;
            const b2c = data.financial.b2c;
            const b2b = data.financial.b2b;

            if (b2c && !streams.find(s => s.id === 'b2c-premium')) {
                const pricing = b2c.pricing || {};
                const assumptions = b2c.assumptions || {};
                streams.unshift({
                    id: 'b2c-premium',
                    name: 'B2C Premium',
                    type: 'user_based',
                    weeklyPrice: Math.round(((pricing.monthly || 10) / 4) * 100) / 100,
                    conversionRate: assumptions.conversionRate || 3,
                    churnRate: assumptions.churnRate || 5,
                    launchWeek: b2c.launchDate || 2,
                    enabled: b2c.enabled !== false,
                    color: '#6366f1'
                });
            }

            if (b2b && !streams.find(s => s.id === 'campaign-revenue')) {
                // Build monthlyPlan from existing campaigns
                const monthlyPlan = {};
                const campaigns = data.financial.campaigns || [];
                const projWeeks = data.projection?.weeks || [];
                // Map date strings to month indices using projection weeks
                const monthDates = {};
                projWeeks.forEach(w => {
                    const m = w.month;
                    if (w.note) {
                        const dateMatch = w.note.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
                        if (dateMatch) {
                            const monthNames = { jan: '01', feb: '02', mar: '03', apr: '04', may: '05', jun: '06', jul: '07', aug: '08', sep: '09', oct: '10', nov: '11', dec: '12' };
                            const mm = monthNames[dateMatch[1].toLowerCase()];
                            if (mm) monthDates['2026-' + mm] = m;
                        }
                    }
                });
                // Fallback: map 2026-01=0, 2026-02=1, etc.
                for (let m = 1; m <= 12; m++) {
                    const key = '2026-' + String(m).padStart(2, '0');
                    if (!(key in monthDates)) monthDates[key] = m - 1;
                }
                campaigns.forEach(c => {
                    const plan = c.monthlyPlan || {};
                    Object.entries(plan).forEach(([dateKey, count]) => {
                        const monthIdx = monthDates[dateKey];
                        if (monthIdx !== undefined) {
                            monthlyPlan[String(monthIdx)] = (monthlyPlan[String(monthIdx)] || 0) + (count || 0);
                        }
                    });
                });
                streams.push({
                    id: 'campaign-revenue',
                    name: 'Campaign Revenue',
                    type: 'campaign',
                    costPerUser: b2b.costPerUser || 0.4,
                    monthlyPlan: monthlyPlan,
                    launchWeek: b2b.launchDate || 6,
                    enabled: b2b.enabled !== false,
                    color: '#22c55e'
                });
            }
        }

        function getScenarioValues() {
            initFinancialData();
            const defaultScenario = { multiplier: 1, b2cConversion: 3, b2bFillRate: 15, b2bCampaigns: 2 };
            const scenarios = data.financial?.scenarios || {};
            const scenario = scenarios[currentFinancialScenario] || scenarios.base || defaultScenario;
            return {
                multiplier: scenario.multiplier ?? 1,
                b2cConversion: scenario.b2cConversion ?? 3,
                b2bFillRate: scenario.b2bFillRate ?? 15,
                b2bCampaigns: scenario.b2bCampaigns ?? 2
            };
        }

        function calculateFinancialProjections() {
            initFinancialData();
            const fin = data.financial;
            const scenario = getScenarioValues();

            // Reset runtime state for user_based streams
            (fin.customStreams || []).forEach(s => { s._premiumUsers = 0; });

            // Get weekly user projections from growth model
            const weeklyGrowth = calculateProjection();

            // Active user percentage (global setting, used by custom streams)
            const activeUserPercent = (fin.b2c?.assumptions?.activeUserPercent || fin.activeUserPercent || 70) / 100;

            // Generate weekly financial projections
            const weeks = [];
            let cumulativeRevenue = 0;

            weeklyGrowth.forEach((week, i) => {
                const totalUsers = week.activeUsers;
                const activeUsers = Math.round(totalUsers * activeUserPercent);

                // Custom Streams Revenue (weekly) - supports fixed, user_based, campaign types
                // All revenue comes from custom streams
                const customStreams = fin.customStreams || [];
                const customRevenues = {};
                let totalCustomRevenue = 0;
                customStreams.forEach(stream => {
                    const launchWeek = parseInt(stream.launchWeek) || 0;
                    if (i >= launchWeek && stream.enabled !== false) {
                        let amount = 0;
                        const type = stream.type || 'fixed';
                        if (type === 'fixed') {
                            amount = Math.round((stream.monthlyAmount || 0) / 4);
                        } else if (type === 'user_based') {
                            const convRate = (stream.conversionRate || 0) / 100;
                            const weeklyChurn = (stream.churnRate || 0) / 100 / 4;
                            const newPremium = Math.round(activeUsers * convRate * 0.25);
                            stream._premiumUsers = Math.round((stream._premiumUsers || 0) * (1 - weeklyChurn) + newPremium);
                            amount = Math.round(stream._premiumUsers * (stream.weeklyPrice || 0));
                        } else if (type === 'campaign') {
                            const weekMonth = week.month;
                            const activations = (stream.monthlyPlan && stream.monthlyPlan[String(weekMonth)]) || 0;
                            const weeksInMonth = weeklyGrowth.filter(w => w.month === weekMonth).length;
                            amount = weeksInMonth > 0 ? Math.round(activeUsers * (stream.costPerUser || 0) * activations / weeksInMonth) : 0;
                        }
                        customRevenues[stream.id] = amount;
                        totalCustomRevenue += amount;
                    } else {
                        customRevenues[stream.id] = 0;
                        if (stream.type === 'user_based') stream._premiumUsers = 0;
                    }
                });

                const weeklyRevenue = totalCustomRevenue;
                cumulativeRevenue += weeklyRevenue;

                // Expenses (weekly) - sum of all expense categories with monthly growth ratio
                const expenses = fin.expenses || [];
                let totalExpenses = 0;
                expenses.forEach(expense => {
                    const launchWeek = parseInt(expense.launchWeek) || 0;
                    const baseWeekly = (expense.monthlyAmount || 0) / 4;
                    const ratio = expense.monthlyRatio || 1;
                    if (i >= launchWeek && expense.enabled !== false) {
                        const monthsElapsed = Math.floor((i - launchWeek) / 4);
                        const multiplier = Math.pow(ratio, monthsElapsed);
                        totalExpenses += Math.round(baseWeekly * multiplier);
                    }
                });

                // EBITDA = Revenue - Expenses
                const weeklyEBITDA = weeklyRevenue - totalExpenses;

                weeks.push({
                    weekId: week.id,
                    weekName: week.name,
                    weekNote: week.note || '',
                    month: week.month,
                    totalUsers,
                    activeUsers,
                    customRevenues,
                    totalCustomRevenue,
                    weeklyRevenue,
                    cumulativeRevenue,
                    totalExpenses,
                    weeklyEBITDA
                });
            });

            return weeks;
        }

        function renderFinancial() {
            initFinancialData();
            const fin = data.financial;
            const projections = calculateFinancialProjections();
            const lastWeek = projections[projections.length - 1] || { weeklyRevenue: 0, activeUsers: 0, totalCustomRevenue: 0 };

            // Calculate totals
            const totalCustom = projections.reduce((sum, w) => sum + (w.totalCustomRevenue || 0), 0);
            const totalRevenue = totalCustom;
            const totalExpenses = projections.reduce((sum, w) => sum + (w.totalExpenses || 0), 0);
            const totalEBITDA = projections.reduce((sum, w) => sum + (w.weeklyEBITDA || 0), 0);
            const customStreams = fin.customStreams || [];
            const expenses = fin.expenses || [];

            // Calculate monthly estimates (last week * 4)
            const estimatedMRR = lastWeek.weeklyRevenue * 4;
            const estimatedOPEX = (lastWeek.totalExpenses || 0) * 4;
            const estimatedEBITDA = estimatedMRR - estimatedOPEX;
            const ebitdaMargin = estimatedMRR > 0 ? ((estimatedEBITDA / estimatedMRR) * 100).toFixed(0) : 0;

            document.getElementById('fin-mrr').textContent = '$' + fmt(estimatedMRR);
            document.getElementById('fin-opex').textContent = '$' + fmt(estimatedOPEX);

            const ebitdaEl = document.getElementById('fin-ebitda');
            ebitdaEl.textContent = '$' + fmt(estimatedEBITDA);
            ebitdaEl.style.color = estimatedEBITDA >= 0 ? 'var(--success)' : 'var(--danger)';

            const marginEl = document.getElementById('fin-ebitda-margin');
            marginEl.textContent = ebitdaMargin + '%';
            marginEl.style.color = estimatedEBITDA >= 0 ? 'var(--success)' : 'var(--danger)';

            // Update weeks count
            document.getElementById('fin-weeks-count').textContent = `${projections.length} weeks`;

            // Get unique months for header grouping
            const months = [...new Set(projections.map(w => w.month))];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Month colors for visual grouping (alternating subtle backgrounds)
            const monthColors = [
                'rgba(99, 102, 241, 0.08)',   // Purple tint
                'rgba(34, 197, 94, 0.08)',    // Green tint
                'rgba(99, 102, 241, 0.08)',   // Purple tint
                'rgba(34, 197, 94, 0.08)',    // Green tint
                'rgba(99, 102, 241, 0.08)',
                'rgba(34, 197, 94, 0.08)',
            ];

            // Map each week to its month color index
            const weekMonthColorMap = projections.map(w => {
                const monthIdx = months.indexOf(w.month);
                return monthColors[monthIdx % monthColors.length];
            });

            // Render matrix header with month groupings (like Time Projection)
            let headerHtml = '<tr><th rowspan="2">Revenue Stream</th><th rowspan="2">Total</th>';
            months.forEach((month, idx) => {
                const weeksInMonth = projections.filter(w => w.month === month).length;
                const monthLabel = monthNames[month] || `M${month}`;
                const bgColor = monthColors[idx % monthColors.length];
                headerHtml += `<th colspan="${weeksInMonth}" style="text-align: center; background: ${bgColor}; border-bottom: 2px solid var(--accent);">${monthLabel}</th>`;
            });
            headerHtml += '</tr><tr>';
            projections.forEach((week, i) => {
                headerHtml += `<th style="font-size: 9px; background: ${weekMonthColorMap[i]};">${week.weekName}</th>`;
            });
            headerHtml += '</tr>';
            document.getElementById('financial-matrix-head').innerHTML = headerHtml;

            // Render matrix body - revenue streams as rows, weeks as columns
            let bodyHtml = '';

            // Row 1: Active Users (from growth model)
            bodyHtml += `<tr style="background: var(--bg-secondary);">`;
            bodyHtml += `<td style="font-weight: 600;">\u{1F465} Active Users</td>`;
            bodyHtml += `<td style="font-weight: 600; color: var(--text-primary);">${fmt(lastWeek.activeUsers)}</td>`;
            projections.forEach((w, i) => {
                bodyHtml += `<td style="color: var(--text-muted); background: ${weekMonthColorMap[i]};">${fmt(w.activeUsers)}</td>`;
            });
            bodyHtml += '</tr>';

            // Separator
            bodyHtml += '<tr style="height: 4px; background: var(--bg-primary);"><td colspan="100"></td></tr>';

            // Custom Revenue Streams (all revenue comes from here)
            customStreams.forEach(stream => {
                const streamTotal = projections.reduce((sum, w) => sum + (w.customRevenues?.[stream.id] || 0), 0);
                const streamColor = stream.color || '#f59e0b';
                const sType = stream.type || 'fixed';
                const typeLabels = { fixed: 'Fixed', user_based: 'User', campaign: 'Campaign' };
                let typeInfo = '';
                if (sType === 'fixed') typeInfo = `$${fmt(stream.monthlyAmount || 0)}/mo`;
                else if (sType === 'user_based') typeInfo = `$${(stream.weeklyPrice || 0).toFixed(2)}/user`;
                else if (sType === 'campaign') typeInfo = `$${(stream.costPerUser || 0).toFixed(2)}/user`;

                bodyHtml += `<tr onclick="showPage('stream', '${stream.id}')" style="cursor: pointer;">`;
                bodyHtml += `<td>
                    <div class="channel-cell" style="display: flex; align-items: center; gap: 8px;">
                        <span class="confidence-dot" style="background: ${streamColor};"></span>
                        <span class="channel-cell-name" style="color: ${streamColor};">\u{1F4CA} ${stream.name}</span>
                        <span style="font-size: 9px; color: var(--text-muted); background: var(--bg-hover); padding: 1px 5px; border-radius: 3px;">${typeLabels[sType]}</span>
                        <span style="font-size: 9px; color: var(--text-muted);">${typeInfo}</span>
                        <button onclick="event.stopPropagation(); deleteCustomStream('${stream.id}')" style="margin-left: auto; background: none; border: none; color: var(--danger); cursor: pointer; font-size: 10px;">x</button>
                    </div>
                </td>`;
                bodyHtml += `<td style="font-weight: 600; color: ${streamColor};">$${fmt(streamTotal)}</td>`;
                projections.forEach((w, i) => {
                    const amount = w.customRevenues?.[stream.id] || 0;
                    const opacity = amount > 0 ? 1 : 0.3;
                    bodyHtml += `<td style="opacity: ${opacity}; color: ${streamColor}; background: ${weekMonthColorMap[i]};">$${fmt(amount)}</td>`;
                });
                bodyHtml += '</tr>';
            });

            // Separator before totals
            bodyHtml += '<tr style="height: 8px; background: var(--bg-primary);"><td colspan="100"></td></tr>';

            // Total Revenue row
            bodyHtml += `<tr class="totals-row">`;
            bodyHtml += `<td><strong>TOTAL REVENUE</strong></td>`;
            bodyHtml += `<td style="font-weight: 700; color: var(--success);">$${fmt(totalRevenue)}</td>`;
            projections.forEach((w, i) => {
                bodyHtml += `<td style="font-weight: 600; background: ${weekMonthColorMap[i]};">$${fmt(w.weeklyRevenue)}</td>`;
            });
            bodyHtml += '</tr>';

            // Separator before expenses
            if (expenses.length > 0) {
                bodyHtml += '<tr style="height: 4px; background: var(--bg-primary);"><td colspan="100"></td></tr>';

                // Expenses section header
                bodyHtml += `<tr style="font-size: 10px; color: var(--text-muted);">`;
                bodyHtml += `<td style="padding-left: 4px; font-weight: 600;">EXPENSES (OPEX)</td>`;
                bodyHtml += `<td></td>`;
                projections.forEach((w, i) => {
                    bodyHtml += `<td style="background: ${weekMonthColorMap[i]};"></td>`;
                });
                bodyHtml += '</tr>';

                // Individual expense rows
                expenses.forEach(expense => {
                    const expenseTotal = projections.reduce((sum, w, i) => {
                        const launchWeek = parseInt(expense.launchWeek) || 0;
                        const weeklyAmount = (expense.monthlyAmount || 0) / 4;
                        return sum + (i >= launchWeek && expense.enabled !== false ? Math.round(weeklyAmount) : 0);
                    }, 0);

                    bodyHtml += `<tr style="cursor: pointer;" onclick="showPage('expense', '${expense.id}')">`;
                    bodyHtml += `<td>
                        <div class="channel-cell" style="display: flex; align-items: center; gap: 8px;">
                            <span class="confidence-dot" style="background: var(--expense);"></span>
                            <span class="channel-cell-name" style="color: var(--expense);">\u{1F4B8} ${expense.name}</span>
                            <span style="font-size: 9px; color: var(--text-muted);">$${fmt(expense.monthlyAmount)}/mo</span>
                            <button onclick="event.stopPropagation(); deleteExpense('${expense.id}')" style="margin-left: auto; background: none; border: none; color: var(--expense); cursor: pointer; font-size: 10px;">x</button>
                        </div>
                    </td>`;
                    bodyHtml += `<td style="font-weight: 600; color: var(--expense);">-$${fmt(expenseTotal)}</td>`;
                    projections.forEach((w, i) => {
                        const launchWeek = parseInt(expense.launchWeek) || 0;
                        const weeklyAmount = (expense.monthlyAmount || 0) / 4;
                        const amount = i >= launchWeek && expense.enabled !== false ? Math.round(weeklyAmount) : 0;
                        const opacity = amount > 0 ? 1 : 0.3;
                        bodyHtml += `<td style="opacity: ${opacity}; color: var(--expense); background: ${weekMonthColorMap[i]};">-$${fmt(amount)}</td>`;
                    });
                    bodyHtml += '</tr>';
                });

                // Total Expenses row
                bodyHtml += `<tr style="font-weight: 600;">`;
                bodyHtml += `<td style="padding-left: 8px;">Total OPEX</td>`;
                bodyHtml += `<td style="color: var(--expense);">-$${fmt(totalExpenses)}</td>`;
                projections.forEach((w, i) => {
                    bodyHtml += `<td style="color: var(--expense); background: ${weekMonthColorMap[i]};">-$${fmt(w.totalExpenses || 0)}</td>`;
                });
                bodyHtml += '</tr>';
            }

            // Separator before EBITDA
            bodyHtml += '<tr style="height: 4px; background: var(--bg-primary);"><td colspan="100"></td></tr>';

            // EBITDA row
            bodyHtml += `<tr class="totals-row" style="font-size: 12px;">`;
            bodyHtml += `<td><strong>EBITDA</strong></td>`;
            const ebitdaColor = totalEBITDA >= 0 ? 'var(--success)' : 'var(--danger)';
            bodyHtml += `<td style="font-weight: 700; color: ${ebitdaColor};">${totalEBITDA >= 0 ? '$' : '-$'}${fmt(Math.abs(totalEBITDA))}</td>`;
            projections.forEach((w, i) => {
                const weekEBITDA = w.weeklyEBITDA || 0;
                const weekColor = weekEBITDA >= 0 ? 'var(--success)' : 'var(--danger)';
                bodyHtml += `<td style="font-weight: 600; color: ${weekColor}; background: ${weekMonthColorMap[i]};">${weekEBITDA >= 0 ? '$' : '-$'}${fmt(Math.abs(weekEBITDA))}</td>`;
            });
            bodyHtml += '</tr>';

            // Cumulative row
            bodyHtml += `<tr style="font-size: 10px; color: var(--text-muted);">`;
            bodyHtml += `<td style="padding-left: 12px;">Cumulative Revenue</td>`;
            bodyHtml += `<td>-</td>`;
            projections.forEach((w, i) => {
                bodyHtml += `<td style="background: ${weekMonthColorMap[i]};">$${fmt(w.cumulativeRevenue)}</td>`;
            });
            bodyHtml += '</tr>';

            document.getElementById('financial-matrix-body').innerHTML = bodyHtml;

            // Render chart (grouped by month) - show total revenue per month
            const monthlyData = {};
            projections.forEach(w => {
                const monthKey = w.month;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { totalRevenue: 0, weeks: 0, streams: {} };
                }
                monthlyData[monthKey].totalRevenue += w.weeklyRevenue;
                monthlyData[monthKey].weeks++;
            });

            const monthKeys = Object.keys(monthlyData).sort((a, b) => a - b);
            const maxRevenue = Math.max(...monthKeys.map(k => monthlyData[k].totalRevenue), 1);
            const chartHeight = 160;

            const chartHtml = monthKeys.map(monthNum => {
                const m = monthlyData[monthNum];
                const barHeight = maxRevenue > 0 ? (m.totalRevenue / maxRevenue) * chartHeight : 0;
                const monthLabel = monthNames[parseInt(monthNum)] || `M${monthNum}`;
                return `
                    <div class="revenue-bar">
                        <div class="revenue-bar-value">$${fmt(m.totalRevenue)}</div>
                        <div class="revenue-bar-stack" style="height: ${barHeight}px;">
                            <div class="revenue-bar-segment" style="height: 100%; background: linear-gradient(180deg, var(--accent), var(--accent-hover));"></div>
                        </div>
                        <div class="revenue-bar-label">${monthLabel}</div>
                        <div style="font-size: 9px; color: var(--text-muted);">${m.weeks}w</div>
                    </div>
                `;
            }).join('');
            document.getElementById('revenue-chart').innerHTML = chartHtml;

            // Update scenario toggle
            document.querySelectorAll('#financial-scenario-toggle .scenario-option').forEach(el => {
                el.classList.toggle('active', el.dataset.scenario === currentFinancialScenario);
            });

            // Render legend (custom streams only)
            let legendHtml = '';
            customStreams.forEach(stream => {
                legendHtml += `
                    <div class="revenue-legend-item">
                        <div class="revenue-legend-dot" style="background: ${stream.color || '#f59e0b'};"></div>
                        <span>${stream.name}</span>
                    </div>
                `;
            });
            document.getElementById('revenue-legend').innerHTML = legendHtml;
        }

                function renderCampaigns() {
            initFinancialData();
            const campaigns = data.financial.campaigns || [];
            const costPerUser = data.financial.b2b?.costPerUser || 0.4; // Legacy reference, campaigns now use per-stream costPerUser
            const projections = calculateFinancialProjections();

            if (campaigns.length === 0) {
                document.getElementById('campaigns-list').innerHTML = `
                    <div class="empty-state">No campaigns planned yet</div>
                `;
                return;
            }

            // Helper to convert campaign month "YYYY-MM" to model month
            function campaignMonthToModelMonth(campaignMonth) {
                const parts = campaignMonth.split('-');
                if (parts.length !== 2) return -1;
                return parseInt(parts[1]) - 1;
            }

            const html = campaigns.map(c => {
                const monthlyPlan = c.monthlyPlan || {};

                // Calculate projected revenue
                let projectedRevenue = 0;
                let activeMonths = 0;
                let totalActivations = 0;

                Object.keys(monthlyPlan).forEach(monthKey => {
                    const multiplier = parseFloat(monthlyPlan[monthKey]) || 0;
                    if (multiplier > 0) {
                        activeMonths++;
                        totalActivations += multiplier;
                        const modelMonth = campaignMonthToModelMonth(monthKey);
                        const monthWeeks = projections.filter(w => w.month === modelMonth);
                        const avgUsers = monthWeeks.length > 0
                            ? monthWeeks.reduce((sum, w) => sum + w.activeUsers, 0) / monthWeeks.length
                            : 0;
                        projectedRevenue += avgUsers * costPerUser * multiplier;
                    }
                });

                const statusInfo = activeMonths > 0
                    ? `${activeMonths} month${activeMonths > 1 ? 's' : ''} ¬∑ ${totalActivations} activation${totalActivations > 1 ? 's' : ''}`
                    : 'Not scheduled';

                return `
                <div class="campaign-row" style="cursor: pointer;" onclick="showPage('campaign', '${c.id}')">
                    <div class="campaign-info">
                        <div class="campaign-status ${c.status}"></div>
                        <div>
                            <div style="font-weight: 600; font-size: 13px;">${c.name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${c.client} ¬∑ ${statusInfo}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--success);">$${fmt(Math.round(projectedRevenue))}</div>
                        <div style="font-size: 10px; color: var(--text-muted);">projected revenue</div>
                    </div>
                </div>
            `}).join('');

            document.getElementById('campaigns-list').innerHTML = html;
        }

        // Current campaign being edited
        let currentCampaignId = null;

        // Get available months from projection weeks
        function getAvailableMonths() {
            const weeks = data.projection?.weeks || [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const months = [];
            const seenMonths = new Set();

            weeks.forEach(week => {
                const monthNum = week.month;
                if (!seenMonths.has(monthNum)) {
                    seenMonths.add(monthNum);
                    // Convert model month (0-11) to YYYY-MM format
                    const year = 2026; // Base year
                    const monthStr = String(monthNum + 1).padStart(2, '0');
                    months.push({
                        key: `${year}-${monthStr}`,
                        label: monthNames[monthNum] || `M${monthNum}`,
                        modelMonth: monthNum
                    });
                }
            });

            return months;
        }

        function renderCampaignDetail(campaignId) {
            initFinancialData();
            currentCampaignId = campaignId;
            const campaign = data.financial.campaigns.find(c => c.id === campaignId);
            const costPerUser = data.financial.b2b?.costPerUser || 0.4; // Legacy reference, campaigns now use per-stream costPerUser

            if (!campaign) {
                showPage('financial');
                showToast('Campaign not found', 'error');
                return;
            }

            // Ensure monthlyPlan exists
            if (!campaign.monthlyPlan) {
                campaign.monthlyPlan = {};
            }

            // Calculate stats from monthly plan
            const monthlyPlan = campaign.monthlyPlan || {};
            let totalActivations = 0;
            let activeMonths = 0;
            Object.values(monthlyPlan).forEach(v => {
                const val = parseFloat(v) || 0;
                if (val > 0) {
                    totalActivations += val;
                    activeMonths++;
                }
            });

            // Calculate projected revenue (rough estimate based on average users)
            const projections = calculateFinancialProjections();
            let projectedRevenue = 0;
            const availableMonths = getAvailableMonths();
            availableMonths.forEach(m => {
                const multiplier = parseFloat(monthlyPlan[m.key]) || 0;
                if (multiplier > 0) {
                    // Get average active users for this month
                    const monthWeeks = projections.filter(w => w.month === m.modelMonth);
                    const avgUsers = monthWeeks.length > 0
                        ? monthWeeks.reduce((sum, w) => sum + w.activeUsers, 0) / monthWeeks.length
                        : 0;
                    projectedRevenue += avgUsers * costPerUser * multiplier;
                }
            });

            // Update header
            document.getElementById('campaign-title').textContent = campaign.name;
            document.getElementById('campaign-subtitle').textContent = campaign.client;

            // Update stats
            document.getElementById('campaign-revenue').textContent = '$' + fmt(Math.round(projectedRevenue));
            document.getElementById('campaign-active-months').textContent = activeMonths;
            document.getElementById('campaign-total-activations').textContent = totalActivations;

            // Populate form fields
            document.getElementById('campaign-name').value = campaign.name || '';
            document.getElementById('campaign-client').value = campaign.client || '';
            document.getElementById('campaign-status').value = campaign.status || 'planned';
            document.getElementById('campaign-notes').value = campaign.notes || '';
            document.getElementById('campaign-cost-per-user').textContent = costPerUser.toFixed(2);

            // Render monthly plan grid with revenue timeline
            const planContainer = document.getElementById('campaign-monthly-plan');
            let planHtml = '';

            availableMonths.forEach(m => {
                const value = monthlyPlan[m.key] || 0;
                const multiplier = parseFloat(value) || 0;
                const isActive = multiplier > 0;

                // Calculate revenue for this month
                const monthWeeks = projections.filter(w => w.month === m.modelMonth);
                const avgUsers = monthWeeks.length > 0
                    ? monthWeeks.reduce((sum, w) => sum + w.activeUsers, 0) / monthWeeks.length
                    : 0;
                const monthRevenue = avgUsers * costPerUser * multiplier;

                planHtml += `
                    <div style="background: var(--bg-card); border: 1px solid ${isActive ? 'var(--success)' : 'var(--border)'}; border-radius: 8px; padding: 12px; min-width: 90px; text-align: center;">
                        <div style="font-size: 11px; font-weight: 600; color: ${isActive ? 'var(--success)' : 'var(--text-muted)'}; margin-bottom: 8px;">${m.label}</div>
                        <input type="number"
                            value="${value}"
                            min="0"
                            step="1"
                            style="width: 50px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; padding: 4px; color: var(--text-primary); font-size: 14px; text-align: center;"
                            onchange="updateCampaignMonthlyPlan('${m.key}', this.value)">
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">activations</div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                            <div style="font-size: 12px; font-weight: 600; color: ${isActive ? 'var(--success)' : 'var(--text-muted)'};">$${fmt(Math.round(monthRevenue))}</div>
                            <div style="font-size: 8px; color: var(--text-muted);">${fmt(Math.round(avgUsers))} users</div>
                        </div>
                    </div>
                `;
            });

            planContainer.innerHTML = planHtml;
        }

        function updateCampaignField(field, value) {
            if (!currentCampaignId) return;
            initFinancialData();

            const campaign = data.financial.campaigns.find(c => c.id === currentCampaignId);
            if (!campaign) return;

            campaign[field] = value;
            save();

            // Update header on change
            document.getElementById('campaign-title').textContent = campaign.name;
            document.getElementById('campaign-subtitle').textContent = campaign.client;

            showToast('Saved', 'success');
        }

        function updateCampaignMonthlyPlan(monthKey, value) {
            if (!currentCampaignId) return;
            initFinancialData();

            const campaign = data.financial.campaigns.find(c => c.id === currentCampaignId);
            if (!campaign) return;

            if (!campaign.monthlyPlan) {
                campaign.monthlyPlan = {};
            }

            const numValue = parseFloat(value) || 0;
            campaign.monthlyPlan[monthKey] = numValue;
            save();

            // Re-render to update stats
            renderCampaignDetail(currentCampaignId);
            showToast('Saved', 'success');
        }

        async function deleteCampaignFromDetail() {
            if (!currentCampaignId) return;
            if (!await showConfirm('Delete this campaign? This cannot be undone.', 'Delete Campaign')) return;

            initFinancialData();
            data.financial.campaigns = data.financial.campaigns.filter(c => c.id !== currentCampaignId);
            save();
            currentCampaignId = null;
            showPage('financial');
            showToast('Campaign deleted', 'success');
        }

        function setFinancialScenario(scenario) {
            currentFinancialScenario = scenario;
            // Re-render financial page
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                if (activePage.id === 'page-financial') renderFinancial();
            }
        }

        function updateFinancialSetting(section, path, value) {
            initFinancialData();
            const parts = path.split('.');
            let obj = data.financial[section];

            for (let i = 0; i < parts.length - 1; i++) {
                obj = obj[parts[i]];
            }

            let numValue = parseFloat(value);

            // Clamp launchDate to valid week range (0-47)
            if (path === 'launchDate') {
                numValue = Math.max(0, Math.min(47, numValue || 0));
            }

            obj[parts[parts.length - 1]] = isNaN(numValue) ? value : numValue;

            save();

            // Re-render the current financial page
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                if (activePage.id === 'page-financial') renderFinancial();
            }
        }

        async function openAddCampaignModal() {
            const name = await showPrompt('Campaign name:', '', 'New Campaign');
            if (!name) return;

            initFinancialData();
            const campaignId = 'campaign_' + Date.now();
            data.financial.campaigns.push({
                id: campaignId,
                name,
                client: 'New Client',
                status: 'planned',
                notes: '',
                monthlyPlan: {}
            });

            save();
            showPage('campaign', campaignId);
            showToast('Campaign created', 'success');
        }

        async function addCustomRevenueStream() {
            const result = await showMultiPrompt([
                { key: 'name', label: 'Stream Name', type: 'text', placeholder: 'e.g., Consulting, Partnerships' },
                { key: 'type', label: 'Revenue Type', type: 'select', default: 'fixed', options: [
                    { value: 'fixed', label: 'Fixed Monthly' },
                    { value: 'user_based', label: 'User-Based' },
                    { value: 'campaign', label: 'Campaign-Based' }
                ]},
                { key: 'monthlyAmount', label: 'Monthly Amount ($)', type: 'number', default: '1000', showWhen: ['fixed'] },
                { key: 'weeklyPrice', label: 'Weekly Price per User ($)', type: 'number', default: '0.50', step: '0.01', showWhen: ['user_based'], hidden: true },
                { key: 'conversionRate', label: 'Conversion Rate (%/month)', type: 'number', default: '3', step: '0.5', showWhen: ['user_based'], hidden: true },
                { key: 'churnRate', label: 'Churn Rate (%/month)', type: 'number', default: '2', step: '0.5', showWhen: ['user_based'], hidden: true },
                { key: 'costPerUser', label: 'Cost per User ($)', type: 'number', default: '0.40', step: '0.01', showWhen: ['campaign'], hidden: true },
                { key: 'launchWeek', label: 'Launch Week', type: 'number', default: '2', min: 0, max: 47 }
            ], 'Add Revenue Stream');

            if (!result || !result.name) return;

            initFinancialData();
            const streamId = 'stream_' + Date.now();
            const streamType = result.type || 'fixed';
            const stream = {
                id: streamId,
                name: result.name,
                type: streamType,
                launchWeek: parseInt(result.launchWeek) || 0,
                enabled: true,
                color: getStreamColor(data.financial.customStreams.length)
            };

            if (streamType === 'fixed') {
                stream.monthlyAmount = parseFloat(result.monthlyAmount) || 0;
            } else if (streamType === 'user_based') {
                stream.weeklyPrice = parseFloat(result.weeklyPrice) || 0;
                stream.conversionRate = parseFloat(result.conversionRate) || 0;
                stream.churnRate = parseFloat(result.churnRate) || 0;
            } else if (streamType === 'campaign') {
                stream.costPerUser = parseFloat(result.costPerUser) || 0;
                stream.monthlyPlan = {};
            }

            data.financial.customStreams.push(stream);
            save();
            showPage('stream', streamId);
            showToast('Revenue stream created', 'success');
        }

        function updateCustomStream(streamId, field, value) {
            initFinancialData();
            const stream = data.financial.customStreams.find(s => s.id === streamId);
            if (!stream) return;

            if (['monthlyAmount', 'launchWeek', 'weeklyPrice', 'conversionRate', 'churnRate', 'costPerUser'].includes(field)) {
                stream[field] = parseFloat(value) || 0;
            } else if (field === 'enabled') {
                stream[field] = value;
            } else {
                stream[field] = value;
            }

            save();
            renderFinancial();
        }

        async function deleteCustomStream(streamId) {
            if (!await showConfirm('Delete this revenue stream?', 'Delete Stream')) return;
            initFinancialData();
            data.financial.customStreams = data.financial.customStreams.filter(s => s.id !== streamId);
            save();
            renderFinancial();
        }

        function getStreamColor(index) {
            const colors = ['#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1'];
            return colors[index % colors.length];
        }

        // =====================================================
        // STREAM DETAIL PAGE
        // =====================================================
        let currentStreamId = null;

        function renderStreamDetail(streamId) {
            initFinancialData();
            currentStreamId = streamId;
            const stream = data.financial.customStreams.find(s => s.id === streamId);

            if (!stream) {
                showPage('financial');
                showToast('Stream not found', 'error');
                return;
            }

            const projections = calculateFinancialProjections();
            const sType = stream.type || 'fixed';
            const typeLabels = { fixed: 'Fixed Monthly', user_based: 'User-Based', campaign: 'Campaign-Based' };

            // Calculate stats
            let totalRevenue = 0;
            let activeWeeks = 0;
            projections.forEach(w => {
                const amount = w.customRevenues?.[stream.id] || 0;
                totalRevenue += amount;
                if (amount > 0) activeWeeks++;
            });

            // Update header
            document.getElementById('stream-title').textContent = stream.name;
            document.getElementById('stream-title').style.color = stream.color || 'var(--warning)';
            document.getElementById('stream-subtitle').textContent = stream.enabled !== false ? typeLabels[sType] : 'Disabled';

            // Update stats
            document.getElementById('stream-total-revenue').textContent = '$' + fmt(totalRevenue);
            document.getElementById('stream-active-weeks').textContent = activeWeeks;
            document.getElementById('stream-type-badge').textContent = typeLabels[sType];

            // Populate form fields
            document.getElementById('stream-name').value = stream.name || '';
            document.getElementById('stream-type').value = sType;
            document.getElementById('stream-launch-week').value = stream.launchWeek || 0;
            document.getElementById('stream-enabled').value = stream.enabled !== false ? 'true' : 'false';

            // Show/hide type-specific fields
            document.getElementById('stream-fields-fixed').style.display = sType === 'fixed' ? '' : 'none';
            document.getElementById('stream-fields-user-based').style.display = sType === 'user_based' ? '' : 'none';
            document.getElementById('stream-fields-campaign').style.display = sType === 'campaign' ? '' : 'none';
            document.getElementById('stream-monthly-plan-section').style.display = sType === 'campaign' ? '' : 'none';

            // Populate type-specific fields
            if (sType === 'fixed') {
                document.getElementById('stream-monthly-amount').value = stream.monthlyAmount || 0;
            } else if (sType === 'user_based') {
                document.getElementById('stream-weekly-price').value = stream.weeklyPrice || 0;
                document.getElementById('stream-conversion-rate').value = stream.conversionRate || 0;
                document.getElementById('stream-churn-rate').value = stream.churnRate || 0;
            } else if (sType === 'campaign') {
                document.getElementById('stream-cost-per-user').value = stream.costPerUser || 0;
            }

            // Render monthly plan for campaign type
            if (sType === 'campaign') {
                const months = [...new Set(projections.map(w => w.month))].sort((a, b) => a - b);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                let planHtml = '';
                months.forEach(monthNum => {
                    const val = (stream.monthlyPlan && stream.monthlyPlan[String(monthNum)]) || 0;
                    const monthLabel = monthNames[monthNum] || `M${monthNum}`;
                    planHtml += `
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; min-width: 90px; text-align: center;">
                            <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">${monthLabel}</div>
                            <input type="number" value="${val}" min="0" step="1"
                                   style="width: 60px; text-align: center; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; padding: 4px; color: var(--text-primary); font-size: 14px;"
                                   onchange="updateStreamMonthlyPlan('${String(monthNum)}', this.value)">
                            <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">activations</div>
                        </div>
                    `;
                });
                document.getElementById('stream-monthly-plan').innerHTML = planHtml;
            }

            // Render monthly timeline
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const months = [...new Set(projections.map(w => w.month))].sort((a, b) => a - b);
            let timelineHtml = '';
            months.forEach(monthNum => {
                const monthWeeks = projections.filter(w => w.month === monthNum);
                let monthRevenue = 0;
                monthWeeks.forEach(w => {
                    monthRevenue += w.customRevenues?.[stream.id] || 0;
                });
                const isActive = monthRevenue > 0;
                const monthLabel = monthNames[monthNum] || `M${monthNum}`;
                const color = stream.color || 'var(--success)';

                timelineHtml += `
                    <div style="background: var(--bg-card); border: 1px solid ${isActive ? color : 'var(--border)'}; border-radius: 8px; padding: 12px; min-width: 90px; text-align: center;">
                        <div style="font-size: 11px; font-weight: 600; color: ${isActive ? color : 'var(--text-muted)'}; margin-bottom: 8px;">${monthLabel}</div>
                        <div style="font-size: 14px; font-weight: 600; color: ${isActive ? color : 'var(--text-muted)'};">
                            ${isActive ? '$' + fmt(monthRevenue) : '-'}
                        </div>
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">${monthWeeks.length} weeks</div>
                    </div>
                `;
            });
            document.getElementById('stream-monthly-timeline').innerHTML = timelineHtml;
        }

        function updateStreamField(field, value) {
            if (!currentStreamId) return;
            initFinancialData();

            const stream = data.financial.customStreams.find(s => s.id === currentStreamId);
            if (!stream) return;

            if (['monthlyAmount', 'launchWeek', 'weeklyPrice', 'conversionRate', 'churnRate', 'costPerUser'].includes(field)) {
                stream[field] = parseFloat(value) || 0;
            } else if (field === 'enabled') {
                stream[field] = value;
            } else if (field === 'type') {
                stream[field] = value;
                // Initialize type-specific defaults if missing
                if (value === 'user_based') {
                    if (!stream.weeklyPrice) stream.weeklyPrice = 0.50;
                    if (!stream.conversionRate) stream.conversionRate = 3;
                    if (!stream.churnRate) stream.churnRate = 2;
                } else if (value === 'campaign') {
                    if (!stream.costPerUser) stream.costPerUser = 0.40;
                    if (!stream.monthlyPlan) stream.monthlyPlan = {};
                }
            } else {
                stream[field] = value;
            }

            save();
            renderStreamDetail(currentStreamId);
            showToast('Saved', 'success');
        }

        function updateStreamMonthlyPlan(monthKey, value) {
            if (!currentStreamId) return;
            initFinancialData();

            const stream = data.financial.customStreams.find(s => s.id === currentStreamId);
            if (!stream) return;

            if (!stream.monthlyPlan) stream.monthlyPlan = {};
            stream.monthlyPlan[monthKey] = parseFloat(value) || 0;
            save();
            renderStreamDetail(currentStreamId);
            showToast('Saved', 'success');
        }

        async function deleteStreamFromDetail() {
            if (!currentStreamId) return;
            if (!await showConfirm('Delete this revenue stream?', 'Delete Stream')) return;

            initFinancialData();
            data.financial.customStreams = data.financial.customStreams.filter(s => s.id !== currentStreamId);
            save();
            currentStreamId = null;
            showPage('financial');
            showToast('Stream deleted', 'success');
        }

        // =====================================================
        // EXPENSES (OPEX)
        // =====================================================
        async function addExpense() {
            const result = await showMultiPrompt([
                { key: 'name', label: 'Expense Name', type: 'text', placeholder: 'e.g., Servers, Accounting, Salaries' },
                { key: 'monthlyAmount', label: 'Monthly Cost ($)', type: 'number', default: '500' },
                { key: 'launchWeek', label: 'Start Week', type: 'number', default: '0', min: 0, max: 47 }
            ], 'Add Expense');

            if (!result || !result.name) return;

            initFinancialData();
            const expenseId = 'expense_' + Date.now();
            data.financial.expenses.push({
                id: expenseId,
                name: result.name,
                monthlyAmount: parseFloat(result.monthlyAmount) || 0,
                launchWeek: parseInt(result.launchWeek) || 0,
                enabled: true,
                notes: '',
                monthlyRatio: 1
            });

            save();
            showPage('expense', expenseId);
            showToast('Expense added', 'success');
        }

        async function deleteExpense(expenseId) {
            if (!await showConfirm('Delete this expense?', 'Delete Expense')) return;
            initFinancialData();
            data.financial.expenses = data.financial.expenses.filter(e => e.id !== expenseId);
            save();
            renderFinancial();
        }

        // Current expense being edited
        let currentExpenseId = null;

        function renderExpenseDetail(expenseId) {
            initFinancialData();
            currentExpenseId = expenseId;
            const expense = data.financial.expenses.find(e => e.id === expenseId);

            if (!expense) {
                showPage('financial');
                showToast('Expense not found', 'error');
                return;
            }

            const projections = calculateFinancialProjections();
            const launchWeek = parseInt(expense.launchWeek) || 0;
            const baseWeekly = (expense.monthlyAmount || 0) / 4;
            const ratio = expense.monthlyRatio || 1;

            // Calculate stats with monthly growth ratio
            let totalCost = 0;
            let activeWeeks = 0;
            projections.forEach((w, i) => {
                if (i >= launchWeek && expense.enabled !== false) {
                    const monthsElapsed = Math.floor((i - launchWeek) / 4);
                    const multiplier = Math.pow(ratio, monthsElapsed);
                    totalCost += Math.round(baseWeekly * multiplier);
                    activeWeeks++;
                }
            });

            // Update header
            document.getElementById('expense-title').textContent = expense.name;
            document.getElementById('expense-subtitle').textContent = expense.enabled !== false ? 'Active expense' : 'Disabled';

            // Update stats
            document.getElementById('expense-monthly').textContent = '$' + fmt(expense.monthlyAmount || 0);
            document.getElementById('expense-total').textContent = '$' + fmt(totalCost);
            document.getElementById('expense-active-weeks').textContent = activeWeeks;

            // Populate form fields
            document.getElementById('expense-name').value = expense.name || '';
            document.getElementById('expense-amount').value = expense.monthlyAmount || 0;
            document.getElementById('expense-launch-week').value = expense.launchWeek || 0;
            document.getElementById('expense-ratio').value = expense.monthlyRatio || 1;
            document.getElementById('expense-enabled').value = expense.enabled !== false ? 'true' : 'false';
            document.getElementById('expense-notes').value = expense.notes || '';

            // Render monthly timeline (group by month)
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const months = [...new Set(projections.map(w => w.month))].sort((a, b) => a - b);
            let timelineHtml = '';

            months.forEach(monthNum => {
                const monthWeeks = projections.filter(w => w.month === monthNum);
                const firstWeekIndex = projections.findIndex(w => w.month === monthNum);

                // Check if expense is active for any week in this month (with growth ratio)
                let monthCost = 0;
                let isActive = false;
                monthWeeks.forEach((w, idx) => {
                    const weekIndex = firstWeekIndex + idx;
                    if (weekIndex >= launchWeek && expense.enabled !== false) {
                        const monthsElapsed = Math.floor((weekIndex - launchWeek) / 4);
                        const multiplier = Math.pow(ratio, monthsElapsed);
                        monthCost += Math.round(baseWeekly * multiplier);
                        isActive = true;
                    }
                });

                const monthLabel = monthNames[monthNum] || `M${monthNum}`;

                timelineHtml += `
                    <div style="background: var(--bg-card); border: 1px solid ${isActive ? 'var(--expense)' : 'var(--border)'}; border-radius: 8px; padding: 12px; min-width: 90px; text-align: center;">
                        <div style="font-size: 11px; font-weight: 600; color: ${isActive ? 'var(--expense)' : 'var(--text-muted)'}; margin-bottom: 8px;">${monthLabel}</div>
                        <div style="font-size: 14px; font-weight: 600; color: ${isActive ? 'var(--expense)' : 'var(--text-muted)'};">
                            ${isActive ? '-$' + fmt(monthCost) : '-'}
                        </div>
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">${monthWeeks.length} weeks</div>
                    </div>
                `;
            });

            document.getElementById('expense-weekly-timeline').innerHTML = timelineHtml;
        }

        function updateExpenseField(field, value) {
            if (!currentExpenseId) return;
            initFinancialData();

            const expense = data.financial.expenses.find(e => e.id === currentExpenseId);
            if (!expense) return;

            if (field === 'monthlyRatio') {
                expense[field] = parseFloat(value) || 1;
            } else if (field === 'monthlyAmount' || field === 'launchWeek') {
                expense[field] = parseFloat(value) || 0;
            } else if (field === 'enabled') {
                expense[field] = value;
            } else {
                expense[field] = value;
            }

            save();

            // Update header and stats
            document.getElementById('expense-title').textContent = expense.name;
            document.getElementById('expense-subtitle').textContent = expense.enabled !== false ? 'Active expense' : 'Disabled';

            // Recalculate and update display
            renderExpenseDetail(currentExpenseId);
            showToast('Saved', 'success');
        }

        async function deleteExpenseFromDetail() {
            if (!currentExpenseId) return;
            if (!await showConfirm('Delete this expense?', 'Delete Expense')) return;

            initFinancialData();
            data.financial.expenses = data.financial.expenses.filter(e => e.id !== currentExpenseId);
            save();
            currentExpenseId = null;
            showPage('financial');
            showToast('Expense deleted', 'success');
        }

        function exportFinancialCSV() {
            const projections = calculateFinancialProjections();
            let csv = 'Week,Month,Total Users,Active Users,Weekly Revenue,Expenses,EBITDA,Cumulative\n';
            projections.forEach(w => {
                csv += `${w.weekName},${w.month},${w.totalUsers},${w.activeUsers},${w.weeklyRevenue},${w.totalExpenses || 0},${w.weeklyEBITDA || 0},${w.cumulativeRevenue}\n`;
            });
            download(csv, 'financial-projection-weekly.csv', 'text/csv');
        }

        // =====================================================
        // INIT
        // =====================================================
        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme();
            await load();
            renderBranding();
            renderSidebar();

            // Handle URL routing - check hash on page load
            if (window.location.hash) {
                handleHashChange();
            } else {
                renderMatrix();
            }

            checkOnboarding();

            document.querySelectorAll('.scenario-option').forEach(el => {
                el.addEventListener('click', () => setScenario(parseFloat(el.dataset.mult)));
            });

            // Listen for hash changes (back/forward browser navigation)
            window.addEventListener('hashchange', handleHashChange);

            // Tooltip positioning (using event delegation)
            document.addEventListener('mouseenter', (e) => {
                if (e.target.classList.contains('tooltip-icon')) {
                    const tooltip = e.target.nextElementSibling;
                    if (tooltip && tooltip.classList.contains('tooltip-content')) {
                        const rect = e.target.getBoundingClientRect();
                        tooltip.style.left = (rect.left + rect.width / 2 - 100) + 'px';
                        tooltip.style.top = (rect.top - 8) + 'px';
                        tooltip.style.transform = 'translateY(-100%)';
                    }
                }
            }, true);
        });
    </script>
</body>
</html>
